const t="app";function e(t){return null==t}function i(t){return function(t){return null!=t&&"string"==typeof t}(t)&&t.trim().length>0}class s{async initialize(t,i,s){this._settings=t.data,this._integrationHelpers=s,this._definition=t,this._logger=i("AppProvider"),this._providerId=t.id,this._integrationHelpers.subscribeLifecycleEvent&&(this._themeChangedSubscriptionId=this._integrationHelpers.subscribeLifecycleEvent("theme-changed",async()=>{await this.rebuildResults()}),this._favChangedSubscriptionId=this._integrationHelpers.subscribeLifecycleEvent("favorite-changed",async(t,i)=>{e(i)||await this.updateAppFavoriteButtons(i)}))}async closedown(){this._integrationHelpers?.unsubscribeLifecycleEvent&&(i(this._themeChangedSubscriptionId)&&(this._integrationHelpers.unsubscribeLifecycleEvent(this._themeChangedSubscriptionId,"theme-changed"),this._themeChangedSubscriptionId=void 0),i(this._favChangedSubscriptionId)&&(this._integrationHelpers.unsubscribeLifecycleEvent(this._favChangedSubscriptionId,"favorite-changed"),this._favChangedSubscriptionId=void 0))}async getHelpSearchEntries(){return[]}async getSearchResults(t,e,i,s){const a=t.toLowerCase();return this._lastResponse=i,await this.getResults(a,e,s)}async itemSelection(i,s){let a=!1;if("user-action"===i.action.trigger)if(i.action.name.endsWith("favorite")&&i.data?.app){const{favoriteClient:s}=await this.getFavInfo(t);s&&(i.action.name.startsWith("un")?!e(i.data?.favoriteId)&&s.deleteSavedFavorite&&await s.deleteSavedFavorite(i.data.favoriteId):s.setSavedFavorite&&await s.setSavedFavorite({id:"randomUUID"in globalThis.crypto?globalThis.crypto.randomUUID():"10000000-1000-4000-8000-100000000000".replace(/[018]/g,function(t){const e=globalThis.crypto.getRandomValues(new Uint8Array(1))[0]&15>>Number(t)/4;return(Number(t)^e).toString(16)}),type:t,typeId:i.key,label:i.title,icon:i.icon}),a=!0)}else if(this._integrationHelpers?.launchApp){const t=i.data;t?.app?.appId&&(a=!0,await this._integrationHelpers.launchApp(t.app.appId,void 0,i.dispatcherIdentity))}return a}async getResults(a,n,r,o){if(this._integrationHelpers?.getApps){const l=r?.queryMinLength??3,p=r?.queryAgainst??["title"];this._lastQuery=a,this._lastQueryMinLength=l,this._lastQueryAgainst=p,this._lastCLIFilters=n;let c=o??await this._integrationHelpers.getApps(),h=a;const{favoriteClient:d,favoriteInfo:u}=await this.getFavInfo(t);if(u?.isEnabled&&i(u?.command)&&a===u.command&&d){const e=await d.getSavedFavorites(t),i=e?.map(t=>t.typeId)??[];c=c.filter(t=>i.includes(t.appId)),h=""}this._lastAppResults=c;const g=await this.mapAppEntriesToSearchEntries(c),f=[];if(g.length>0){const t=g.filter(t=>{let a=!0,r=!0;const o=h.startsWith("/");(h.length>=l||o)&&(a=p.some(s=>{const a=t,n=s.split(".");if(1===n.length){const t=a[n[0]];if(i(t)){const e=t.toLowerCase();return o?e.startsWith(h):e.includes(h)}}else if(2===n.length){const t=a[n[0]];if(null!=(r=t)&&"object"==typeof r&&!Array.isArray(r)){let s;if(e(t)||(s=t[n[1]]),i(s)){const t=s.toLowerCase();return o?t.startsWith(h):t.includes(h)}if(Array.isArray(s)){if(s.length>0&&i(s[0])&&s.some(t=>t.toLowerCase().startsWith(h)))return!0;this._logger?.warn(`Manifest configuration for search specified a queryAgainst target that is an array but not an array of strings. Only string values and arrays are supported: ${JSON.stringify(t)}`)}}}else this._logger?.warn("The manifest configuration for search has a queryAgainst entry that has a depth greater than 1. You can search for e.g. data.tags if data has tags in it and it is either a string or an array of strings");var r;return!1}));const c=Array.isArray(n)?n.filter(t=>t.id===s._HOME_TAG_FILTERS):[];return c.length>0&&(r=c.some(i=>{if(Array.isArray(i.options)){if(!e(t.data?.app?.tags))return i.options.every(e=>!e.isSelected||t.data.app.tags.includes(e.value))}else if(i.options.isSelected&&!e(t.data?.app?.tags))return t.data.app.tags.includes(i.options.value);return!0})),a&&Array.isArray(t.data?.app?.tags)&&f.push(...t.data.app.tags),a&&r});return this._lastResultIds=t.map(t=>t.key),{results:t,context:{filters:this.getSearchFilters(f.filter(Boolean))}}}}return this._lastResultIds=[],{results:[],context:{filters:[]}}}getSearchFilters(t){if(Array.isArray(t)){const e=[],i=[...new Set(t)].sort((t,e)=>t.localeCompare(e)),a={id:s._HOME_TAG_FILTERS,title:"Tags",type:"MultiSelect",options:[]};for(const t of i)Array.isArray(a.options)&&a.options.push({value:t,isSelected:!0});return e.push(a),e}return[]}async mapAppEntriesToSearchEntries(e){const i=[];if(Array.isArray(e)&&this._integrationHelpers){let s;const{favoriteClient:a,favoriteInfo:n}=await this.getFavInfo(t);a&&(s=await a.getSavedFavorites(t));for(const t of e){const e=s?.find(e=>e.typeId===t.appId)?.id,a=await this.mapAppEntryToSearchEntry(t,this._settings?.manifestTypeMapping,n,e);a&&i.push(a)}}return i}async mapAppEntryToSearchEntry(t,a,n,r){const o=t.manifestType;if(i(o)){const l={name:"Launch View",hotkey:"enter"},p={key:t.appId,score:this._definition?.baseScore??s._DEFAULT_BASE_SCORE,title:t.title,data:{app:t,providerId:this._providerId,favoriteId:r}};if(!e(a)){const t=a[o];e(t)||(i(t.entryLabel)&&(p.label=t.entryLabel),i(t.actionName)&&(l.name=t.actionName))}p.actions=[l],p.icon=this.getAppIcon(t),e(t.description)||(p.description=t.description,p.shortDescription=t.description);const c=[];if(n?.favoriteIcon&&n.unfavoriteIcon&&this._integrationHelpers){const t=await this._integrationHelpers.getThemeClient(),i=await t.themeUrl(e(r)?n.unfavoriteIcon:n.favoriteIcon);i&&c.push({icon:i,action:e(r)?"favorite":"unfavorite"})}return p.template="Custom",p.templateContent=await(this._integrationHelpers?.templateHelpers.createApp(t,p.icon??"",l.name,c)),p}}getAppIcon(t){if(Array.isArray(t.icons)&&t.icons.length>0)return t.icons[0].src}async rebuildResults(){if(!e(this._lastResponse)&&Array.isArray(this._lastResultIds)&&!e(this._lastQuery)&&!e(this._lastCLIFilters)&&!e(this._lastQueryAgainst)&&!e(this._lastQueryMinLength)&&!e(this._lastResultIds)){this._logger?.info("Rebuilding results...");const t=this._lastResultIds.slice(),e=await this.getResults(this._lastQuery,this._lastCLIFilters,{queryMinLength:this._lastQueryMinLength,queryAgainst:this._lastQueryAgainst},this._lastAppResults),i=t.filter(t=>!this._lastResultIds?.includes(t));i.length>0&&this._lastResponse.revoke(...i),this._lastResponse.respond(e.results),this._logger?.info("Results rebuilt.")}}async updateAppFavoriteButtons(i){const s=i.favorite;if(!e(this._lastResponse)&&("set"===i.action||"delete"===i.action)&&!e(s)&&s.type===t&&this._lastAppResults&&this._integrationHelpers){const{favoriteInfo:a}=await this.getFavInfo(t);if(this._lastQuery===a?.command&&"delete"===i.action)this._lastResponse.revoke(s.typeId);else if(this._lastAppResults){let t=this._lastAppResults.find(t=>t.appId===s.typeId);if(!t&&this._integrationHelpers?.getApp&&this._lastQuery===a?.command&&(t=await this._integrationHelpers.getApp(s.typeId)),!e(t)){const e=await this.mapAppEntryToSearchEntry(t,this._settings?.manifestTypeMapping,a,"set"===i.action?s.id:void 0);e&&this._lastResponse.respond([e])}}}}async getFavInfo(t){let e,i;return(this._definition?.data?.favoritesEnabled??1)&&this._integrationHelpers?.getFavoriteClient&&(i=await this._integrationHelpers.getFavoriteClient(),i&&(e=i.getInfo(),e.isEnabled))&&((e?.enabledTypes?.includes(t)??1)||(e=void 0,i=void 0)),{favoriteClient:i,favoriteInfo:e}}}s._DEFAULT_BASE_SCORE=0,s._HOME_TAG_FILTERS="tags";const a={integrations:new s};export{a as entryPoints};
//# sourceMappingURL=apps.bundle.js.map