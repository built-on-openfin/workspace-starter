var t={d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{k:()=>r});const i="app";function s(t){return null==t}function a(t){return function(t){return null!=t&&"string"==typeof t}(t)&&t.trim().length>0}class n{async initialize(t,e,i){this._settings=t.data,this._integrationHelpers=i,this._definition=t,this._logger=e("AppProvider"),this._providerId=t.id,this._integrationHelpers.subscribeLifecycleEvent&&(this._themeChangedSubscriptionId=this._integrationHelpers.subscribeLifecycleEvent("theme-changed",(async()=>{await this.rebuildResults()})),this._favChangedSubscriptionId=this._integrationHelpers.subscribeLifecycleEvent("favorite-changed",(async(t,e)=>{s(e)||await this.updateAppFavoriteButtons(e)})))}async closedown(){this._integrationHelpers?.unsubscribeLifecycleEvent&&(a(this._themeChangedSubscriptionId)&&(this._integrationHelpers.unsubscribeLifecycleEvent(this._themeChangedSubscriptionId,"theme-changed"),this._themeChangedSubscriptionId=void 0),a(this._favChangedSubscriptionId)&&(this._integrationHelpers.unsubscribeLifecycleEvent(this._favChangedSubscriptionId,"favorite-changed"),this._favChangedSubscriptionId=void 0))}async getHelpSearchEntries(){return[]}async getSearchResults(t,e,i,s){const a=t.toLowerCase();return this._lastResponse=i,await this.getResults(a,e,s)}async itemSelection(t,e){let a=!1;if("user-action"===t.action.trigger)if(t.action.name.endsWith("favorite")&&t.data?.app){const{favoriteClient:e}=await this.getFavInfo(i);e&&(t.action.name.startsWith("un")?!s(t.data?.favoriteId)&&e.deleteSavedFavorite&&await e.deleteSavedFavorite(t.data.favoriteId):e.setSavedFavorite&&await e.setSavedFavorite({id:"randomUUID"in globalThis.crypto?globalThis.crypto.randomUUID():"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(function(t){const e=globalThis.crypto.getRandomValues(new Uint8Array(1))[0]&15>>Number(t)/4;return(Number(t)^e).toString(16)})),type:i,typeId:t.key,label:t.title,icon:t.icon}),a=!0)}else if(this._integrationHelpers?.launchApp){const e=t.data;e?.app?.appId&&(a=!0,await this._integrationHelpers.launchApp(e.app.appId,void 0,t.dispatcherIdentity))}return a}async getResults(t,e,r,o){if(this._integrationHelpers?.getApps){const l=r?.queryMinLength??3,p=r?.queryAgainst??["title"];this._lastQuery=t,this._lastQueryMinLength=l,this._lastQueryAgainst=p,this._lastCLIFilters=e;let c=o??await this._integrationHelpers.getApps(),h=t;const{favoriteClient:d,favoriteInfo:u}=await this.getFavInfo(i);if(u?.isEnabled&&a(u?.command)&&t===u.command&&d){const t=await d.getSavedFavorites(i),e=t?.map((t=>t.typeId))??[];c=c.filter((t=>e.includes(t.appId))),h=""}this._lastAppResults=c;const g=await this.mapAppEntriesToSearchEntries(c),f=[];if(g.length>0){const t=g.filter((t=>{let i=!0,r=!0;const o=h.startsWith("/");(h.length>=l||o)&&(i=p.some((e=>{const i=t,n=e.split(".");if(1===n.length){const t=i[n[0]];if(a(t)){const e=t.toLowerCase();return o?e.startsWith(h):e.includes(h)}}else if(2===n.length){const t=i[n[0]];if(null!=(r=t)&&"object"==typeof r&&!Array.isArray(r)){let e;if(s(t)||(e=t[n[1]]),a(e)){const t=e.toLowerCase();return o?t.startsWith(h):t.includes(h)}if(Array.isArray(e)){if(e.length>0&&a(e[0])&&e.some((t=>t.toLowerCase().startsWith(h))))return!0;this._logger?.warn(`Manifest configuration for search specified a queryAgainst target that is an array but not an array of strings. Only string values and arrays are supported: ${JSON.stringify(t)}`)}}}else this._logger?.warn("The manifest configuration for search has a queryAgainst entry that has a depth greater than 1. You can search for e.g. data.tags if data has tags in it and it is either a string or an array of strings");var r;return!1})));const c=Array.isArray(e)?e.filter((t=>t.id===n._HOME_TAG_FILTERS)):[];return c.length>0&&(r=c.some((e=>{if(Array.isArray(e.options)){if(!s(t.data?.app?.tags))return e.options.every((e=>!e.isSelected||t.data.app.tags.includes(e.value)))}else if(e.options.isSelected&&!s(t.data?.app?.tags))return t.data.app.tags.includes(e.options.value);return!0}))),i&&Array.isArray(t.data?.app?.tags)&&f.push(...t.data.app.tags),i&&r}));return this._lastResultIds=t.map((t=>t.key)),{results:t,context:{filters:this.getSearchFilters(f.filter(Boolean))}}}}return this._lastResultIds=[],{results:[],context:{filters:[]}}}getSearchFilters(t){if(Array.isArray(t)){const e=[],i=[...new Set(t)].sort(((t,e)=>t.localeCompare(e))),s={id:n._HOME_TAG_FILTERS,title:"Tags",type:"MultiSelect",options:[]};for(const t of i)Array.isArray(s.options)&&s.options.push({value:t,isSelected:!0});return e.push(s),e}return[]}async mapAppEntriesToSearchEntries(t){const e=[];if(Array.isArray(t)&&this._integrationHelpers){let s;const{favoriteClient:a,favoriteInfo:n}=await this.getFavInfo(i);a&&(s=await a.getSavedFavorites(i));for(const i of t){const t=s?.find((t=>t.typeId===i.appId))?.id,a=await this.mapAppEntryToSearchEntry(i,this._settings?.manifestTypeMapping,n,t);a&&e.push(a)}}return e}async mapAppEntryToSearchEntry(t,e,i,r){const o=t.manifestType;if(a(o)){const l={name:"Launch View",hotkey:"enter"},p={key:t.appId,score:this._definition?.baseScore??n._DEFAULT_BASE_SCORE,title:t.title,data:{app:t,providerId:this._providerId,favoriteId:r}};if(!s(e)){const t=e[o];s(t)||(a(t.entryLabel)&&(p.label=t.entryLabel),a(t.actionName)&&(l.name=t.actionName))}p.actions=[l],p.icon=this.getAppIcon(t),s(t.description)||(p.description=t.description,p.shortDescription=t.description);const c=[];if(i?.favoriteIcon&&i.unfavoriteIcon&&this._integrationHelpers){const t=await this._integrationHelpers.getThemeClient(),e=await t.themeUrl(s(r)?i.unfavoriteIcon:i.favoriteIcon);e&&c.push({icon:e,action:s(r)?"favorite":"unfavorite"})}return p.template="Custom",p.templateContent=await(this._integrationHelpers?.templateHelpers.createApp(t,p.icon??"",l.name,c)),p}}getAppIcon(t){if(Array.isArray(t.icons)&&t.icons.length>0)return t.icons[0].src}async rebuildResults(){if(!s(this._lastResponse)&&Array.isArray(this._lastResultIds)&&!s(this._lastQuery)&&!s(this._lastCLIFilters)&&!s(this._lastQueryAgainst)&&!s(this._lastQueryMinLength)&&!s(this._lastResultIds)){this._logger?.info("Rebuilding results...");const t=this._lastResultIds.slice(),e=await this.getResults(this._lastQuery,this._lastCLIFilters,{queryMinLength:this._lastQueryMinLength,queryAgainst:this._lastQueryAgainst},this._lastAppResults),i=t.filter((t=>!this._lastResultIds?.includes(t)));i.length>0&&this._lastResponse.revoke(...i),this._lastResponse.respond(e.results),this._logger?.info("Results rebuilt.")}}async updateAppFavoriteButtons(t){const e=t.favorite;if(!s(this._lastResponse)&&("set"===t.action||"delete"===t.action)&&!s(e)&&e.type===i&&this._lastAppResults&&this._integrationHelpers){const{favoriteInfo:a}=await this.getFavInfo(i);if(this._lastQuery===a?.command&&"delete"===t.action)this._lastResponse.revoke(e.typeId);else if(this._lastAppResults){let i=this._lastAppResults.find((t=>t.appId===e.typeId));if(!i&&this._integrationHelpers?.getApp&&this._lastQuery===a?.command&&(i=await this._integrationHelpers.getApp(e.typeId)),!s(i)){const s=await this.mapAppEntryToSearchEntry(i,this._settings?.manifestTypeMapping,a,"set"===t.action?e.id:void 0);s&&this._lastResponse.respond([s])}}}}async getFavInfo(t){let e,i;return(this._definition?.data?.favoritesEnabled??1)&&this._integrationHelpers?.getFavoriteClient&&(i=await this._integrationHelpers.getFavoriteClient(),i&&(e=i.getInfo(),e.isEnabled))&&((e?.enabledTypes?.includes(t)??1)||(e=void 0,i=void 0)),{favoriteClient:i,favoriteInfo:e}}}n._DEFAULT_BASE_SCORE=0,n._HOME_TAG_FILTERS="tags";const r={integrations:new n};var o=e.k;export{o as entryPoints};
//# sourceMappingURL=apps.bundle.js.map