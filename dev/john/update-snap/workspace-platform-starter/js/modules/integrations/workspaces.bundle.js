var t={d:(e,i)=>{for(var a in i)t.o(i,a)&&!t.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:i[a]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{k:()=>r});const i="workspace";function a(t){return null==t}function s(t){return function(t){return null!=t&&"string"==typeof t}(t)&&t.trim().length>0}function n(){return"randomUUID"in globalThis.crypto?globalThis.crypto.randomUUID():"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(function(t){const e=globalThis.crypto.getRandomValues(new Uint8Array(1))[0]&15>>Number(t)/4;return(Number(t)^e).toString(16)}))}class o{async initialize(t,e,s){this._settings=t.data,this._integrationHelpers=s,this._definition=t,this._logger=e("WorkspacesProvider"),this._integrationHelpers.subscribeLifecycleEvent&&(this._integrationHelpers.subscribeLifecycleEvent("workspace-changed",(async(t,e)=>{if("create"===e?.action||"apply"===e?.action)a(this._lastQuery)||this._lastQuery.startsWith("/w ")||await this.rebuildResults(t);else if("update"===e?.action){const t=this._lastResults?.find((t=>t.key===e.id));if(t&&e.workspace){t.title=e.workspace.title,t.data.workspaceTitle=e.workspace.title,t.templateContent.data.title=e.workspace.title,this.resultAddUpdate([t]);const{favoriteClient:a}=await this.getFavInfo(i);if(a?.setSavedFavorite){const t=await a.getSavedFavorites(i),s=await(t?.find((t=>t.typeId===e.id)));s&&(s.label=e.workspace.title,await a.setSavedFavorite(s))}}}else if("delete"===e?.action){this.resultRemove(e.id);const{favoriteClient:t}=await this.getFavInfo(i);if(t?.deleteSavedFavorite){const a=await t.getSavedFavorites(i),s=await(a?.find((t=>t.typeId===e.id)));s&&await t.deleteSavedFavorite(s.id)}}})),this._themeChangedSubscriptionId=this._integrationHelpers.subscribeLifecycleEvent("theme-changed",(async()=>{if(this._integrationHelpers?.getPlatform){const t=this._integrationHelpers.getPlatform();await this.rebuildResults(t)}})),this._favChangedSubscriptionId=this._integrationHelpers.subscribeLifecycleEvent("favorite-changed",(async(t,e)=>{a(e)||await this.updateAppFavoriteButtons(e)})))}async closedown(){this._integrationHelpers?.unsubscribeLifecycleEvent&&(s(this._themeChangedSubscriptionId)&&(this._integrationHelpers.unsubscribeLifecycleEvent(this._themeChangedSubscriptionId,"theme-changed"),this._themeChangedSubscriptionId=void 0),s(this._favChangedSubscriptionId)&&(this._integrationHelpers.unsubscribeLifecycleEvent(this._favChangedSubscriptionId,"favorite-changed"),this._favChangedSubscriptionId=void 0))}async getHelpSearchEntries(){if(this._integrationHelpers&&this._settings){const t=await this._integrationHelpers.getThemeClient();return[{key:`${this._definition?.id}-help1`,score:this._definition?.baseScore??o._DEFAULT_BASE_SCORE,title:"Workspaces",label:"Help",icon:await t.themeUrl(this._settings.images.workspace),actions:[],data:{providerId:this._definition?.id},template:"Custom",templateContent:await this._integrationHelpers.templateHelpers.createHelp("Workspaces",["Use the workspaces command to save your current layout."],["/w title"])}]}return[]}async getSearchResults(t,e,a,r){if(this._integrationHelpers?.getPlatform&&this._settings){const e=await this._integrationHelpers.getThemeClient(),l=this._integrationHelpers.getPlatform(),c=t.toLowerCase(),p=r?.queryMinLength??3;let d=await l.Storage.getWorkspaces(),h=c;if(this._lastResponse=a,this._lastQuery=c,this._lastQueryMinLength=p,c.startsWith("/w ")){const t=c.replace("/w ",""),i=d.find((e=>e.title.toLowerCase()===t.toLowerCase()));return i?{results:[{key:o._ACTION_EXISTS_WORKSPACE,score:this._definition?.baseScore??o._DEFAULT_BASE_SCORE,title:`Workspace ${i.title} already exists.`,icon:await e.themeUrl(this._settings.images.workspace),actions:[],data:{providerId:this._definition?.id,tags:["workspace"],workspaceId:i.workspaceId},template:"Plain",templateContent:void 0}]}:{results:[{key:o._ACTION_SAVE_WORKSPACE,score:this._definition?.baseScore??o._DEFAULT_BASE_SCORE,title:`Save Current Workspace as ${t}`,icon:await e.themeUrl(this._settings.images.workspace),label:"Suggestion",actions:[{name:"Save Workspace",hotkey:"Enter"}],data:{providerId:this._definition?.id,tags:["workspace"],workspaceId:n(),workspaceTitle:t},template:"Plain",templateContent:void 0}]}}const{favoriteClient:_,favoriteInfo:g}=await this.getFavInfo(i);if(g?.isEnabled&&s(g?.command)&&c===g.command&&_){const t=await _.getSavedFavorites(i),e=t?.map((t=>t.typeId))??[];d=d.filter((t=>e.includes(t.workspaceId))),h=""}const u=await this.buildResults(l,d,h,p);return this._lastResults=u,{results:u}}return{results:[]}}async itemSelection(t,e){let s=!1;if("user-action"===t.action.trigger)if(t.action.name.endsWith("favorite")&&t.data?.workspaceId){const{favoriteClient:e}=await this.getFavInfo(i);e&&(t.action.name.startsWith("un")?!a(t.data?.favoriteId)&&e.deleteSavedFavorite&&await e.deleteSavedFavorite(t.data.favoriteId):e.setSavedFavorite&&await e.setSavedFavorite({id:n(),type:i,typeId:t.key,label:t.title,icon:this._settings?.images.workspace}),s=!0)}else if(this._integrationHelpers?.getPlatform){const e=t.data;if(e?.workspaceId)if(s=!0,t.key===o._ACTION_SAVE_WORKSPACE){this.resultRemove(t.key);const a=this._integrationHelpers.getPlatform(),s=await a.getSnapshot(),n=await a.getCurrentWorkspace(),o=n?.metadata,r={workspaceId:e.workspaceId,title:e.workspaceTitle??"",metadata:o,snapshot:s};await a.Storage.saveWorkspace(r);let l=!1;if(this._integrationHelpers?.getShareClient){const t=await this._integrationHelpers.getShareClient();t&&(l=await t.typeEnabled("workspace"))}const{favoriteInfo:c}=await this.getFavInfo(i),p=await this.getWorkspaceTemplate(r.workspaceId,r.title,l,!0,c);this.resultAddUpdate([p])}else if(t.key===o._ACTION_EXISTS_WORKSPACE);else if(t.action.name===o._ACTION_OPEN_WORKSPACE){const t=this._integrationHelpers.getPlatform(),i=await t.Storage.getWorkspace(e.workspaceId);i?(await t.applyWorkspace(i),await this.rebuildResults(t)):this._logger?.warn(`Workspace not found: ${e.workspaceId}`)}else if(t.action.name===o._ACTION_DELETE_WORKSPACE){const t=this._integrationHelpers.getPlatform();await t.Storage.deleteWorkspace(e.workspaceId)}else if(t.action.name===o._ACTION_SHARE_WORKSPACE&&this._integrationHelpers.getShareClient){const t=await this._integrationHelpers.getShareClient();t&&await t.share("workspace",{workspaceId:e.workspaceId})}else s=!1,this._logger?.warn(`Unrecognized action for workspace selection: ${e.workspaceId}`)}return s}async getWorkspaceTemplate(t,e,i,s,n,r){if(this._integrationHelpers&&this._settings){const l=[{name:o._ACTION_OPEN_WORKSPACE,hotkey:"Enter"}],c=[{title:"Open",action:o._ACTION_OPEN_WORKSPACE}];let p;s?p="This is the currently active workspace. You can use the Browser menu to update/rename this workspace":(p="Use the buttons below to interact with your saved workspace",l.push({name:o._ACTION_DELETE_WORKSPACE,hotkey:"CmdOrCtrl+Shift+D"}),c.push({title:"Delete",action:o._ACTION_DELETE_WORKSPACE})),i&&(l.push({name:o._ACTION_SHARE_WORKSPACE,hotkey:"CmdOrCtrl+Shift+S"}),c.push({title:"Share",action:o._ACTION_SHARE_WORKSPACE}));const d=await this._integrationHelpers.getThemeClient(),h=await d.themeUrl(this._settings.images.workspace),_=[];if(n?.favoriteIcon&&n.unfavoriteIcon){const t=await d.themeUrl(a(r)?n.unfavoriteIcon:n.favoriteIcon);t&&_.push({icon:t,action:a(r)?"favorite":"unfavorite"})}const g=await this._integrationHelpers.templateHelpers.createLayout(e,h,[await this._integrationHelpers.templateHelpers.createText("instructions")],c,_);return{key:t,score:this._definition?.baseScore??o._DEFAULT_BASE_SCORE,title:e,label:"Workspace",icon:h,actions:l,data:{providerId:this._definition?.id,workspaceTitle:e,workspaceId:t,tags:["workspace"],favoriteId:r},template:"Custom",templateContent:{layout:g.layout,data:{...g.data,instructions:p}}}}return{key:t,score:this._definition?.baseScore??o._DEFAULT_BASE_SCORE,title:e,label:"Workspace",actions:[],data:{providerId:this._definition?.id,workspaceTitle:e,workspaceId:t,tags:["workspace"]},template:"Plain",templateContent:void 0}}async rebuildResults(t){if(this._integrationHelpers&&!a(this._lastQuery)&&!a(this._lastQueryMinLength)){const e=await t.Storage.getWorkspaces(),i=await this.buildResults(t,e,this._lastQuery,this._lastQueryMinLength);this.resultAddUpdate(i)}}async buildResults(t,e,a,s){let n=[];if(this._integrationHelpers&&Array.isArray(e)){const o=await t.getCurrentWorkspace(),r=o?.workspaceId;let l=!1;if(this._integrationHelpers?.getShareClient){const t=await this._integrationHelpers.getShareClient();t&&(l=await t.typeEnabled("workspace"))}const{favoriteClient:c,favoriteInfo:p}=await this.getFavInfo(i);let d;c&&(d=await c.getSavedFavorites(i));const h=e.filter((t=>0===a.length||a.length>=s&&t.title.toLowerCase().includes(a))).sort(((t,e)=>t.title.localeCompare(e.title))).map((async t=>{const e=d?.find((e=>e.typeId===t.workspaceId))?.id;return this.getWorkspaceTemplate(t.workspaceId,t.title,l,r===t.workspaceId,p,e)}));n=await Promise.all(h)}return n}resultAddUpdate(t){if(this._lastResults)for(const e of t){const t=this._lastResults.findIndex((t=>t.key===e.key));t>=0?this._lastResults.splice(t,1,e):this._lastResults.push(e)}this._lastResponse&&this._lastResponse.respond(t)}resultRemove(t){if(this._lastResults){const e=this._lastResults.findIndex((e=>e.key===t));e>=0&&this._lastResults.splice(e,1)}this._lastResponse&&this._lastResponse.revoke(t)}async updateAppFavoriteButtons(t){const e=t.favorite;if(!a(this._lastResponse)&&this._integrationHelpers?.getPlatform&&("set"===t.action||"delete"===t.action)&&!a(e)&&e.type===i&&this._lastResults){const{favoriteInfo:s}=await this.getFavInfo(i);if(this._lastQuery===s?.command&&"delete"===t.action)this._lastResponse.revoke(e.typeId);else if(this._lastResults){const i=this._lastResults.find((t=>t.key===e.typeId));if(!a(i)){let a=!1;if(this._integrationHelpers?.getConditionsClient){const t=await this._integrationHelpers.getConditionsClient();t&&(a=await t.check("sharing"))}const n=this._integrationHelpers.getPlatform(),o=await n.getCurrentWorkspace(),r=o?.workspaceId,l=await this.getWorkspaceTemplate(i.key,i.title,a,r===i.key,s,"set"===t.action?e.id:void 0);this._lastResponse.respond([l])}}}}async getFavInfo(t){let e,i;return(this._definition?.data?.favoritesEnabled??1)&&this._integrationHelpers?.getFavoriteClient&&(i=await this._integrationHelpers.getFavoriteClient(),i&&(e=i.getInfo(),e.isEnabled))&&((e?.enabledTypes?.includes(t)??1)||(e=void 0,i=void 0)),{favoriteClient:i,favoriteInfo:e}}}o._DEFAULT_BASE_SCORE=100,o._ACTION_OPEN_WORKSPACE="Open Workspace",o._ACTION_DELETE_WORKSPACE="Delete Workspace",o._ACTION_SHARE_WORKSPACE="Share Workspace",o._ACTION_SAVE_WORKSPACE="Save Workspace",o._ACTION_EXISTS_WORKSPACE="Workspace Exists";const r={integrations:new o};var l=e.k;export{l as entryPoints};
//# sourceMappingURL=workspaces.bundle.js.map