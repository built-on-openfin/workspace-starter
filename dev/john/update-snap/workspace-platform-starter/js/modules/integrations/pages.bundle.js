var t={d:(e,i)=>{for(var a in i)t.o(i,a)&&!t.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:i[a]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)},e={};t.d(e,{k:()=>o});const i="page";function a(t){return null==t}function s(t){return function(t){return null!=t&&"string"==typeof t}(t)&&t.trim().length>0}class n{async initialize(t,e,s){this._settings=t.data,this._integrationHelpers=s,this._logger=e("PagesProvider"),this._definition=t,this._integrationHelpers.subscribeLifecycleEvent&&(this._integrationHelpers.subscribeLifecycleEvent("page-changed",(async(t,e)=>{if("create"===e?.action)await this.rebuildResults(t);else if("update"===e?.action){const t=this._lastResults?.find((t=>t.key===e.id));if(t&&e.page){t.title=e.page.title,t.data.workspaceTitle=e.page.title,t.templateContent.data.title=e.page.title,this.resultAddUpdate([t]);const{favoriteClient:a}=await this.getFavInfo(i);if(a?.setSavedFavorite){const t=await a.getSavedFavorites(i),s=await(t?.find((t=>t.typeId===e.id)));s&&(s.label=e.page.title,await a.setSavedFavorite(s))}}}else if("delete"===e?.action){this.resultRemove(e.id);const{favoriteClient:t}=await this.getFavInfo(i);if(t?.deleteSavedFavorite){const a=await t.getSavedFavorites(i),s=await(a?.find((t=>t.typeId===e.id)));s&&await t.deleteSavedFavorite(s.id)}}})),this._themeChangedSubscriptionId=this._integrationHelpers.subscribeLifecycleEvent("theme-changed",(async()=>{if(this._integrationHelpers?.getPlatform){const t=this._integrationHelpers.getPlatform();await this.rebuildResults(t)}})),this._favChangedSubscriptionId=this._integrationHelpers.subscribeLifecycleEvent("favorite-changed",(async(t,e)=>{a(e)||await this.updateAppFavoriteButtons(e)})))}async closedown(){this._integrationHelpers?.unsubscribeLifecycleEvent&&(s(this._themeChangedSubscriptionId)&&(this._integrationHelpers.unsubscribeLifecycleEvent(this._themeChangedSubscriptionId,"theme-changed"),this._themeChangedSubscriptionId=void 0),s(this._favChangedSubscriptionId)&&(this._integrationHelpers.unsubscribeLifecycleEvent(this._favChangedSubscriptionId,"favorite-changed"),this._favChangedSubscriptionId=void 0))}async getHelpSearchEntries(){return[]}async getSearchResults(t,e,a,n){let o=[];if(this._integrationHelpers?.getPlatform){const e=this._integrationHelpers.getPlatform(),r=t.toLowerCase(),l=n?.queryMinLength??3;let g=await e.Storage.getPages(),h=r;this._lastResponse=a,this._lastQuery=r,this._lastQueryMinLength=l;const{favoriteClient:d,favoriteInfo:c}=await this.getFavInfo(i);if(c?.isEnabled&&s(c?.command)&&r===c.command&&d){const t=await d.getSavedFavorites(i),e=t?.map((t=>t.typeId))??[];g=g.filter((t=>e.includes(t.pageId))),h=""}o=await this.buildResults(g,h,l),this._lastResults=o}return{results:o}}async itemSelection(t,e){let s=!1;if("user-action"===t.action.trigger)if(t.action.name.endsWith("favorite")&&t.data?.pageId){const{favoriteClient:e}=await this.getFavInfo(i);e&&(t.action.name.startsWith("un")?!a(t.data?.favoriteId)&&e.deleteSavedFavorite&&await e.deleteSavedFavorite(t.data.favoriteId):e.setSavedFavorite&&await e.setSavedFavorite({id:"randomUUID"in globalThis.crypto?globalThis.crypto.randomUUID():"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(function(t){const e=globalThis.crypto.getRandomValues(new Uint8Array(1))[0]&15>>Number(t)/4;return(Number(t)^e).toString(16)})),type:i,typeId:t.key,label:t.title,icon:this._settings?.images.page}),s=!0)}else{const e=t.data;if(e?.pageId)if(s=!0,t.action.name===n._ACTION_LAUNCH_PAGE)this._integrationHelpers?.getPlatform&&this._integrationHelpers?.launchPage&&await this._integrationHelpers.launchPage(e.pageId,void 0,this._logger);else if(t.action.name===n._ACTION_DELETE_PAGE){if(this._integrationHelpers?.getPlatform){const t=this._integrationHelpers.getPlatform();await t.Storage.deletePage(e.pageId)}}else if(t.action.name===n._ACTION_SHARE_PAGE&&this._integrationHelpers?.getShareClient){const t=await this._integrationHelpers.getShareClient();t&&await t.share("page",{pageId:e.pageId})}else s=!1,this._logger?.warn(`Unrecognized action for page selection: ${e.pageId}`)}return s}async getPageTemplate(t,e,i,s,o){if(this._integrationHelpers&&this._settings){const r=[{name:n._ACTION_LAUNCH_PAGE,hotkey:"Enter"},{name:n._ACTION_DELETE_PAGE,hotkey:"CmdOrCtrl+Shift+D"}],l=[{title:"Launch",action:n._ACTION_LAUNCH_PAGE},{title:"Delete",action:n._ACTION_DELETE_PAGE}];i&&(r.push({name:n._ACTION_SHARE_PAGE,hotkey:"CmdOrCtrl+Shift+S"}),l.push({title:"Share",action:n._ACTION_SHARE_PAGE}));const g=await this._integrationHelpers.getThemeClient(),h=await g.themeUrl(this._settings.images.page),d=[];if(s?.favoriteIcon&&s.unfavoriteIcon){const t=await g.themeUrl(a(o)?s.unfavoriteIcon:s.favoriteIcon);t&&d.push({icon:t,action:a(o)?"favorite":"unfavorite"})}const c=await this._integrationHelpers.templateHelpers.createLayout(e,h,[await this._integrationHelpers.templateHelpers.createText("instructions")],l,d);return{key:t,score:this._definition?.baseScore??n._DEFAULT_BASE_SCORE,title:e,label:"Page",icon:h,actions:r,data:{providerId:this._definition?.id,pageTitle:e,pageId:t,tags:["page"],favoriteId:o},template:"Custom",templateContent:{layout:c.layout,data:{...c.data,instructions:"Use the buttons below to interact with your saved page"}}}}return{key:t,score:this._definition?.baseScore??n._DEFAULT_BASE_SCORE,title:e,label:"Page",actions:[],data:{providerId:this._definition?.id,pageTitle:e,pageId:t,tags:["page"]},template:"Plain",templateContent:void 0}}async rebuildResults(t){if(this._integrationHelpers&&!a(this._lastQuery)&&!a(this._lastQueryMinLength)){const e=await t.Storage.getPages(),i=await this.buildResults(e,this._lastQuery,this._lastQueryMinLength);this.resultAddUpdate(i)}}async buildResults(t,e,a){let s=[];if(this._integrationHelpers&&Array.isArray(t)){let n=!1;if(this._integrationHelpers?.getShareClient){const t=await this._integrationHelpers.getShareClient();t&&(n=await t.typeEnabled("page"))}const{favoriteClient:o,favoriteInfo:r}=await this.getFavInfo(i);let l;o&&(l=await o.getSavedFavorites(i));const g=t.filter((t=>0===e.length||e.length>=a&&t.title.toLowerCase().includes(e))).sort(((t,e)=>t.title.localeCompare(e.title))).map((async t=>{const e=l?.find((e=>e.typeId===t.pageId))?.id;return this.getPageTemplate(t.pageId,t.title,n,r,e)}));s=await Promise.all(g)}return s}resultAddUpdate(t){if(this._lastResults)for(const e of t){const t=this._lastResults.findIndex((t=>t.key===e.key));t>=0?this._lastResults.splice(t,1,e):this._lastResults.push(e)}this._lastResponse&&this._lastResponse.respond(t)}resultRemove(t){if(this._lastResults){const e=this._lastResults.findIndex((e=>e.key===t));e>=0&&this._lastResults.splice(e,1)}this._lastResponse&&this._lastResponse.revoke(t)}async updateAppFavoriteButtons(t){const e=t.favorite;if(!a(this._lastResponse)&&("set"===t.action||"delete"===t.action)&&!a(e)&&e.type===i&&this._lastResults&&this._integrationHelpers){const{favoriteInfo:s}=await this.getFavInfo(i);if(this._lastQuery===s?.command&&"delete"===t.action)this._lastResponse.revoke(e.typeId);else if(this._lastResults){const i=this._lastResults.find((t=>t.key===e.typeId));if(!a(i)){let a=!1;if(this._integrationHelpers?.getShareClient){const t=await this._integrationHelpers.getShareClient();t&&(a=await t.typeEnabled("page"))}const n=await this.getPageTemplate(i.key,i.title,a,s,"set"===t.action?e.id:void 0);this._lastResponse.respond([n])}}}}async getFavInfo(t){let e,i;return(this._definition?.data?.favoritesEnabled??1)&&this._integrationHelpers?.getFavoriteClient&&(i=await this._integrationHelpers.getFavoriteClient(),i&&(e=i.getInfo(),e.isEnabled))&&((e?.enabledTypes?.includes(t)??1)||(e=void 0,i=void 0)),{favoriteClient:i,favoriteInfo:e}}}n._DEFAULT_BASE_SCORE=200,n._ACTION_LAUNCH_PAGE="Launch Page",n._ACTION_DELETE_PAGE="Delete Page",n._ACTION_SHARE_PAGE="Share Page";const o={integrations:new n};var r=e.k;export{r as entryPoints};
//# sourceMappingURL=pages.bundle.js.map