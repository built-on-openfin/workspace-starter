const t="page";function e(t){return null==t}function i(t){return function(t){return null!=t&&"string"==typeof t}(t)&&t.trim().length>0}class a{async initialize(i,a,s){this._settings=i.data,this._integrationHelpers=s,this._logger=a("PagesProvider"),this._definition=i,this._integrationHelpers.subscribeLifecycleEvent&&(this._integrationHelpers.subscribeLifecycleEvent("page-changed",(async(e,i)=>{if("create"===i?.action)await this.rebuildResults(e);else if("update"===i?.action){const e=this._lastResults?.find((t=>t.key===i.id));if(e&&i.page){e.title=i.page.title,e.data.workspaceTitle=i.page.title,e.templateContent.data.title=i.page.title,this.resultAddUpdate([e]);const{favoriteClient:a}=await this.getFavInfo(t);if(a?.setSavedFavorite){const e=await a.getSavedFavorites(t),s=await(e?.find((t=>t.typeId===i.id)));s&&(s.label=i.page.title,await a.setSavedFavorite(s))}}}else if("delete"===i?.action){this.resultRemove(i.id);const{favoriteClient:e}=await this.getFavInfo(t);if(e?.deleteSavedFavorite){const a=await e.getSavedFavorites(t),s=await(a?.find((t=>t.typeId===i.id)));s&&await e.deleteSavedFavorite(s.id)}}})),this._themeChangedSubscriptionId=this._integrationHelpers.subscribeLifecycleEvent("theme-changed",(async()=>{if(this._integrationHelpers?.getPlatform){const t=this._integrationHelpers.getPlatform();await this.rebuildResults(t)}})),this._favChangedSubscriptionId=this._integrationHelpers.subscribeLifecycleEvent("favorite-changed",(async(t,i)=>{e(i)||await this.updateAppFavoriteButtons(i)})))}async closedown(){this._integrationHelpers?.unsubscribeLifecycleEvent&&(i(this._themeChangedSubscriptionId)&&(this._integrationHelpers.unsubscribeLifecycleEvent(this._themeChangedSubscriptionId,"theme-changed"),this._themeChangedSubscriptionId=void 0),i(this._favChangedSubscriptionId)&&(this._integrationHelpers.unsubscribeLifecycleEvent(this._favChangedSubscriptionId,"favorite-changed"),this._favChangedSubscriptionId=void 0))}async getHelpSearchEntries(){return[]}async getSearchResults(e,a,s,n){let o=[];if(this._integrationHelpers?.getPlatform){const a=this._integrationHelpers.getPlatform(),r=e.toLowerCase(),l=n?.queryMinLength??3;let g=await a.Storage.getPages(),h=r;this._lastResponse=s,this._lastQuery=r,this._lastQueryMinLength=l;const{favoriteClient:d,favoriteInfo:c}=await this.getFavInfo(t);if(c?.isEnabled&&i(c?.command)&&r===c.command&&d){const e=await d.getSavedFavorites(t),i=e?.map((t=>t.typeId))??[];g=g.filter((t=>i.includes(t.pageId))),h=""}o=await this.buildResults(g,h,l),this._lastResults=o}return{results:o}}async itemSelection(i,s){let n=!1;if("user-action"===i.action.trigger)if(i.action.name.endsWith("favorite")&&i.data?.pageId){const{favoriteClient:a}=await this.getFavInfo(t);a&&(i.action.name.startsWith("un")?!e(i.data?.favoriteId)&&a.deleteSavedFavorite&&await a.deleteSavedFavorite(i.data.favoriteId):a.setSavedFavorite&&await a.setSavedFavorite({id:"randomUUID"in globalThis.crypto?globalThis.crypto.randomUUID():"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(function(t){const e=globalThis.crypto.getRandomValues(new Uint8Array(1))[0]&15>>Number(t)/4;return(Number(t)^e).toString(16)})),type:t,typeId:i.key,label:i.title,icon:this._settings?.images.page}),n=!0)}else{const t=i.data;if(t?.pageId)if(n=!0,i.action.name===a._ACTION_LAUNCH_PAGE)this._integrationHelpers?.getPlatform&&this._integrationHelpers?.launchPage&&await this._integrationHelpers.launchPage(t.pageId,void 0,this._logger);else if(i.action.name===a._ACTION_DELETE_PAGE){if(this._integrationHelpers?.getPlatform){const e=this._integrationHelpers.getPlatform();await e.Storage.deletePage(t.pageId)}}else if(i.action.name===a._ACTION_SHARE_PAGE&&this._integrationHelpers?.getShareClient){const e=await this._integrationHelpers.getShareClient();e&&await e.share("page",{pageId:t.pageId})}else n=!1,this._logger?.warn(`Unrecognized action for page selection: ${t.pageId}`)}return n}async getPageTemplate(t,i,s,n,o){if(this._integrationHelpers&&this._settings){const r=[{name:a._ACTION_LAUNCH_PAGE,hotkey:"Enter"},{name:a._ACTION_DELETE_PAGE,hotkey:"CmdOrCtrl+Shift+D"}],l=[{title:"Launch",action:a._ACTION_LAUNCH_PAGE},{title:"Delete",action:a._ACTION_DELETE_PAGE}];s&&(r.push({name:a._ACTION_SHARE_PAGE,hotkey:"CmdOrCtrl+Shift+S"}),l.push({title:"Share",action:a._ACTION_SHARE_PAGE}));const g=await this._integrationHelpers.getThemeClient(),h=await g.themeUrl(this._settings.images.page),d=[];if(n?.favoriteIcon&&n.unfavoriteIcon){const t=await g.themeUrl(e(o)?n.unfavoriteIcon:n.favoriteIcon);t&&d.push({icon:t,action:e(o)?"favorite":"unfavorite"})}const c=await this._integrationHelpers.templateHelpers.createLayout(i,h,[await this._integrationHelpers.templateHelpers.createText("instructions")],l,d);return{key:t,score:this._definition?.baseScore??a._DEFAULT_BASE_SCORE,title:i,label:"Page",icon:h,actions:r,data:{providerId:this._definition?.id,pageTitle:i,pageId:t,tags:["page"],favoriteId:o},template:"Custom",templateContent:{layout:c.layout,data:{...c.data,instructions:"Use the buttons below to interact with your saved page"}}}}return{key:t,score:this._definition?.baseScore??a._DEFAULT_BASE_SCORE,title:i,label:"Page",actions:[],data:{providerId:this._definition?.id,pageTitle:i,pageId:t,tags:["page"]},template:"Plain",templateContent:void 0}}async rebuildResults(t){if(this._integrationHelpers&&!e(this._lastQuery)&&!e(this._lastQueryMinLength)){const e=await t.Storage.getPages(),i=await this.buildResults(e,this._lastQuery,this._lastQueryMinLength);this.resultAddUpdate(i)}}async buildResults(e,i,a){let s=[];if(this._integrationHelpers&&Array.isArray(e)){let n=!1;if(this._integrationHelpers?.getShareClient){const t=await this._integrationHelpers.getShareClient();t&&(n=await t.typeEnabled("page"))}const{favoriteClient:o,favoriteInfo:r}=await this.getFavInfo(t);let l;o&&(l=await o.getSavedFavorites(t));const g=e.filter((t=>0===i.length||i.length>=a&&t.title.toLowerCase().includes(i))).sort(((t,e)=>t.title.localeCompare(e.title))).map((async t=>{const e=l?.find((e=>e.typeId===t.pageId))?.id;return this.getPageTemplate(t.pageId,t.title,n,r,e)}));s=await Promise.all(g)}return s}resultAddUpdate(t){if(this._lastResults)for(const e of t){const t=this._lastResults.findIndex((t=>t.key===e.key));t>=0?this._lastResults.splice(t,1,e):this._lastResults.push(e)}this._lastResponse&&this._lastResponse.respond(t)}resultRemove(t){if(this._lastResults){const e=this._lastResults.findIndex((e=>e.key===t));e>=0&&this._lastResults.splice(e,1)}this._lastResponse&&this._lastResponse.revoke(t)}async updateAppFavoriteButtons(i){const a=i.favorite;if(!e(this._lastResponse)&&("set"===i.action||"delete"===i.action)&&!e(a)&&a.type===t&&this._lastResults&&this._integrationHelpers){const{favoriteInfo:s}=await this.getFavInfo(t);if(this._lastQuery===s?.command&&"delete"===i.action)this._lastResponse.revoke(a.typeId);else if(this._lastResults){const t=this._lastResults.find((t=>t.key===a.typeId));if(!e(t)){let e=!1;if(this._integrationHelpers?.getShareClient){const t=await this._integrationHelpers.getShareClient();t&&(e=await t.typeEnabled("page"))}const n=await this.getPageTemplate(t.key,t.title,e,s,"set"===i.action?a.id:void 0);this._lastResponse.respond([n])}}}}async getFavInfo(t){let e,i;return(this._definition?.data?.favoritesEnabled??1)&&this._integrationHelpers?.getFavoriteClient&&(i=await this._integrationHelpers.getFavoriteClient(),i&&(e=i.getInfo(),e.isEnabled))&&((e?.enabledTypes?.includes(t)??1)||(e=void 0,i=void 0)),{favoriteClient:i,favoriteInfo:e}}}a._DEFAULT_BASE_SCORE=200,a._ACTION_LAUNCH_PAGE="Launch Page",a._ACTION_DELETE_PAGE="Delete Page",a._ACTION_SHARE_PAGE="Share Page";const s={integrations:new a};export{s as entryPoints};
//# sourceMappingURL=pages.bundle.js.map