var e={d:(t,r)=>{for(var o in r)e.o(r,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:r[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{MS:()=>$,_7:()=>xe,cX:()=>K,zL:()=>We,_W:()=>H,p8:()=>L,YR:()=>Ne,U$:()=>$e,U7:()=>Ke,OF:()=>Le});var r={d:(e,t)=>{for(var o in t)r.o(t,o)&&!r.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},o={};r.d(o,{MS:()=>n,cF:()=>i,AK:()=>s,M_:()=>a,cX:()=>c,Yd:()=>_,O4:()=>j,_W:()=>d,p8:()=>l,m$:()=>g,U$:()=>y,U7:()=>v,OV:()=>f,N7:()=>P,HP:()=>u,Rp:()=>U});class n extends Error{constructor(e,t){var r,o;super(e=null!==(r=null!=e?e:null==t?void 0:t.message)&&void 0!==r?r:"An unexpected error has occurred"),this.name=this.constructor.name,this.stack=(e?this.stack:null!==(o=null==t?void 0:t.stack)&&void 0!==o?o:this.stack).replace(/^(\w*Error)/,`${this.constructor.name}`)}}class i extends n{constructor(e,t,r){var o;super(e=null!==(o=null!=e?e:null==r?void 0:r.message)&&void 0!==o?o:"An error occurred when executing the API request",r),this.status=t}}class a extends n{constructor(e,t){var r;super(e=null!==(r=null!=e?e:null==t?void 0:t.message)&&void 0!==r?r:"An authorization error occurred",t)}}class s extends n{constructor(e,t){var r;super(e=null!==(r=null!=e?e:null==t?void 0:t.message)&&void 0!==r?r:"The API request failed as the authorization tokens have expired",t)}}class c extends n{constructor(e,t){var r;super(e=null!==(r=null!=e?e:null==t?void 0:t.message)&&void 0!==r?r:"An initialization error occurred",t)}}class d extends n{constructor(e){super(e=null!=e?e:"Invalid parameter detected")}}class l extends n{constructor(e,t){var r;super(e=null!==(r=null!=e?e:null==t?void 0:t.message)&&void 0!==r?r:"A token validation error occurred",t)}}const u=()=>void 0!==crypto.randomUUID?crypto.randomUUID():"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>{const t=window.crypto.getRandomValues(new Uint8Array(1))[0]&15>>Number(e)/4;return(Number(e)^t).toString(16)}),h="oauth-api-auth-flow",p=(e,t,r,o,n,i,s,c)=>async d=>{const l=new URL(d);if(0!==l.href.toLowerCase().indexOf(n.toLowerCase()))return!1;if(window.clearInterval(c),window.clearTimeout(t),window.clearTimeout(r),e.removeAllListeners(),e.close(!0),l.searchParams.get("error")){const e=new a("Authorization error");return e.data=l.toString(),s(e),!0}if(l.searchParams.get("state")!==o){const e=new a("State mismatch");return e.data=l.toString(),s(e),!0}const u=l.searchParams.get("code");if(!u){const e=new a("Authorization code missing");return e.data=l.toString(),s(e),!0}return i(u),!0},g=async(e,t,r={})=>{const{defaultHeight:o,defaultWidth:n}=r;return t(await fin.Window.create(Object.assign({alwaysOnTop:!0,maximizable:!1,minimizable:!1,autoShow:!1,defaultCentered:!0,defaultHeight:null!=o?o:750,defaultWidth:null!=n?n:600,includeInSnapshots:!1,name:h,resizable:!1,saveWindowState:!1,showTaskbarIcon:!1,url:e},r)))},w=(e,t,r)=>o=>new Promise((n,i)=>{let s;const c=window.setTimeout(()=>{window.clearInterval(s),window.clearTimeout(c),o.removeAllListeners(),o.close(!0),i(new a("Authorization timed out"))},3e5);o.addListener("closing",async()=>{r.logInfo("User closed auth window"),window.clearInterval(s),window.clearTimeout(c),o.removeAllListeners(),i(new a("Failed to complete authorization code flow"))});const d=window.setTimeout(async()=>{try{await o.isShowing()||(r.logInfo("Showing auth window"),await o.show(!0),await o.focus())}catch(e){r.logWarning("Unable to show auth window")}},2e3);(async()=>{const{version:l}=await fin.System.getRuntimeInfo();parseInt(l.split(".")[0],10)>=30?await p(o,c,d,e,t,n,i)((await o.getInfo()).url)||await o.addListener("url-changed",a=>{r.logInfo("Auth window navigated to",a.url),p(o,c,d,e,t,n,i)(a.url)}):s=window.setInterval(()=>(async(e,t,r,o,n,i,s,c)=>{let d;try{d=await e.getInfo()}catch(e){return window.clearInterval(t),window.clearTimeout(r),window.clearTimeout(o),c(new a("Could not locate auth window")),!1}return p(e,r,o,n,i,s,c,t)(d.url)})(o,s,c,d,e,t,n,i),500)})()}),f=async(e,t)=>{let r;null==t||t.logInfo("Retrieving authorization server metadata",e);try{r=new URL(e)}catch(e){throw new d("Unexpected invalid discovery URL")}const o=await fetch(r,{headers:{Accept:"application/json"}});if(!o.ok)throw new Error("Failed to retrieve authorization server metadata");const n=await o.json();if(!n)throw new Error("Unexpected empty authorization server metadata response");return null==t||t.logInfo("Retrieved authorization server metadata",n),n},m=e=>{let t=fin.Integrations;t||(fin.Integrations={},t=fin.Integrations);let r=t[e];return r||(t[e]={},r=t[e]),r},y=e=>{m(e).loggingEnabled=!1},v=(e,t="0.0.0")=>{m(e).loggingEnabled=!0,console.log(b(e),`v${t}`)},b=e=>`[@openfin/${e.toLowerCase()}]`;class _{constructor(e){this.name=e,this.prefix=b(e),this.isLoggingEnabled=this.isLoggingEnabled.bind(this),this.logError=this.logError.bind(this),this.logInfo=this.logInfo.bind(this),this.logWarning=this.logWarning.bind(this)}isLoggingEnabled(){return m(this.name).loggingEnabled}logError(e){this.isLoggingEnabled()&&(e.innerError?console.error(this.prefix,e,"\n\n(inner)",e.innerError):console.error(this.prefix,e))}logInfo(...e){this.isLoggingEnabled()&&console.log(this.prefix,...e)}logWarning(...e){this.isLoggingEnabled()&&console.warn(this.prefix,...e)}}const S=()=>{let e,t,r,o,n;const i=async(t,r=!1)=>{const{command:o,data:n,id:s}=t,c={command:o,id:s};try{if(!e)throw new Error("Access token not found");const{apiRequestUrl:o,data:s,headers:d,httpMethod:l,includeAuthorization:u}=n,h=await(async(t,r,o,n,i)=>{var a,s;const c=Object.assign({Accept:"application/json"},n);"PATCH"!==r&&"POST"!==r&&"PUT"!==r||/content-type/i.test(Object.keys(c).join(","))||(c["Content-Type"]="application/json"),i&&(c.Authorization=`Bearer ${e}`);const d=await fetch(t,{body:"object"==typeof o?JSON.stringify(o):o,headers:c,method:r});if(!d.ok){const e={message:"Failed to execute API request"};return(null===(a=d.headers.get("Content-Type"))||void 0===a?void 0:a.includes("application/json"))&&(e.data=await d.json()),[d.status,void 0,void 0,e]}let l;const u=null!==(s=d.headers.get("Content-Type"))&&void 0!==s?s:"";switch(!0){case!u:break;case/^application\/(\w+\+)?json/i.test(u):l=await d.json();break;case/^multipart\/form-?data|^application\/x-?www-?form-?urlencoded/i.test(u):l=await d.formData();break;case/^application\/(([^/]+)?xml|vnd\.openxmlformats)|^text\/|^image\/svg/i.test(u):l=await d.text();break;default:l=await d.arrayBuffer()}return[d.status,l,u,void 0]})(o,l,s,d,u),[p,g,w,f]=h;if(c.status=p,f){if(!r&&401===p){const[e,r]=await a();return r?(c.status=e,c.error=r,c):await i(t,!0)}c.error=f}else g&&(c.data=g,c.type=w)}catch(e){e instanceof Error?c.error={message:e.message}:c.error={message:"Failed to execute API request"}}return Promise.resolve(c)},a=async()=>{var r;if(!o)throw new Error("Authorization server metadata not set");if(!t)throw new Error("Client ID not set");const i=`grant_type=refresh_token&client_id=${t}&refresh_token=${n}`,a=await fetch(o.token_endpoint,{body:i,headers:{Accept:"application/json","Content-Type":"application/x-www-form-urlencoded"},method:"POST"});if(!a.ok){const e={message:"Failed to refresh access token"};return(null===(r=a.headers.get("Content-Type"))||void 0===r?void 0:r.includes("application/json"))&&(e.data=await a.json()),[a.status,e]}const s=await a.json();return e=s.access_token,[a.status]};self.onmessage=async a=>{const{command:s,id:c}=a.data;let d={command:s,id:c};switch(s){case"API_REQUEST":d=await i(a.data);break;case"CODE_EXCHANGE":d=await(async i=>{var a;const{command:s,data:c,id:d}=i,l={command:s,id:d};try{if(!o)throw new Error("Authorization server metadata not set");if(!t)throw new Error("Client ID not set");const{code:i,codeVerifier:s,redirectUri:d}=c,u=`grant_type=authorization_code&client_id=${t}&code=${i}&code_verifier=${s}&redirect_uri=${d}`,h=await fetch(o.token_endpoint,{body:u,headers:{Accept:"application/json","Content-Type":"application/x-www-form-urlencoded"},method:"POST"});if(h.ok){const t=await h.json();e=t.access_token,r=t.id_token,n=t.refresh_token}else{const e={message:"Failed to retrieve tokens"};(null===(a=h.headers.get("Content-Type"))||void 0===a?void 0:a.includes("application/json"))&&(e.data=await h.json()),l.error=e}}catch(e){e instanceof Error?l.error={message:e.message}:l.error={message:"Failed to retrieve tokens"}}return Promise.resolve(l)})(a.data);break;case"EXPIRE_TOKENS":d=await(async r=>{var i;const{command:a,expireAccessTokenOnly:s,id:c}=r,d={command:a,id:c};try{if(!o)throw new Error("Authorization server metadata not set");if(!o.revocation_endpoint)throw new Error("Revocation endpoint missing in authorization server metadata");if(!s&&!n)throw new Error("Refresh token not found");const r=o.revocation_endpoint;let a,c=!1;const l={body:`client_id=${t}`,headers:{Accept:"application/json","Content-Type":"application/x-www-form-urlencoded"},method:"POST"};if(s){const t=await fetch(r,Object.assign(Object.assign({},l),{body:`${l.body}&token=${e}&token_type_hint=access_token`}));t.ok||(c=!0,(null===(i=t.headers.get("Content-Type"))||void 0===i?void 0:i.includes("application/json"))&&(a=await t.json()))}else{const t=(await Promise.all([await fetch(r,Object.assign(Object.assign({},l),{body:`${l.body}&token=${e}&token_type_hint=access_token`})),await fetch(r,Object.assign(Object.assign({},l),{body:`${l.body}&token=${n}&token_type_hint=refresh_token`}))])).filter(e=>!e.ok);t.length&&(c=!0,a=await t[0].json())}if(c){const e={data:a,message:"Failed to expire tokens"};d.error=e}}catch(e){e instanceof Error?d.error={message:e.message}:d.error={message:"Failed to expire tokens"}}return Promise.resolve(d)})(a.data);break;case"GET_ID_TOKEN":l=a.data,d=Object.assign(Object.assign({},l),{idToken:r});break;case"INIT":d=await(async e=>{const{command:r,data:n,id:i}=e,a={command:r,id:i};return t=n.clientId,o=n.metadata,Promise.resolve(a)})(a.data);break;default:d.error=new Error(`Unexpected oauth worker command: ${s}`)}var l;self.postMessage(d)}};var E;!function(e){e.ApiRequest="API_REQUEST",e.CodeExchange="CODE_EXCHANGE",e.ExpireTokens="EXPIRE_TOKENS",e.GetIdToken="GET_ID_TOKEN",e.Init="INIT"}(E||(E={}));const I=[],k=e=>{I.push(e)},A=(e,t)=>(r,o,n)=>new Promise((i,a)=>{const s={command:E.CodeExchange,data:{code:r,codeVerifier:o,redirectUri:n},id:u()},{command:c,id:d}=s;k({command:c,id:d,reject:a,resolve:i}),e.postMessage(s),t.logInfo("Worker request sent",s)}),T=(e,t,r)=>(o,n,i,a,s)=>new Promise((c,d)=>{const l={command:E.ApiRequest,data:{apiRequestUrl:o,clientId:e,data:i,headers:a,httpMethod:n,includeAuthorization:s},id:u()},{command:h,id:p}=l;k({command:h,id:p,reject:d,resolve:c}),t.postMessage(l),r.logInfo("Worker request sent",l)}),R=(e,t)=>r=>new Promise((o,n)=>{const i={command:E.ExpireTokens,expireAccessTokenOnly:r,id:u()},{command:a,id:s}=i;k({command:a,id:s,reject:n,resolve:o}),e.postMessage(i),t.logInfo("Worker request sent",i)}),O=(e,t)=>async()=>(await new Promise((r,o)=>{const n={command:E.GetIdToken,id:u()},{command:i,id:a}=n;k({command:i,id:a,reject:o,resolve:r}),e.postMessage(n),t.logInfo("Worker request sent",n)})).idToken,P=async(e,t,r)=>{const o=new Blob([`(${S})()`],{type:"text/javascript"}),n=URL.createObjectURL(o),i=new Worker(n);return i.onmessage=C(r),await((e,t,r,o)=>new Promise((n,i)=>{const a={command:E.Init,data:{clientId:t,metadata:e},id:u()},{command:s,id:c}=a;k({command:s,id:c,reject:i,resolve:n}),r.postMessage(a),o.logInfo("Worker request sent",a)}))(e,t,i,r),{exchangeCodeForTokens:A(i,r),executeApiRequest:T(t,i,r),expireTokens:R(i,r),getIdToken:O(i,r),terminate:W(i,r)}},C=e=>t=>{e.logInfo("Worker response received",t.data);const r=t.data,{command:o,error:n,id:i}=r,a=function(e,t){var r={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(r[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(o=Object.getOwnPropertySymbols(e);n<o.length;n++)t.indexOf(o[n])<0&&Object.prototype.propertyIsEnumerable.call(e,o[n])&&(r[o[n]]=e[o[n]])}return r}(r,["command","error","id"]),s=((e,t)=>I.find(r=>r.command===t&&r.id===e))(i,o);s?(n?("status"in a&&void 0!==a.status&&(n.status=a.status),s.reject(n)):s.resolve(a),x(i,o)):e.logError(new Error("Unable to locate awaited request"))},x=(e,t)=>{const r=I.findIndex(r=>r.command===t&&r.id===e);r>=0&&I.splice(r,1)},W=(e,t)=>async()=>{try{await R(e,t)(!1)}catch(e){t.logWarning(e.message)}e.terminate(),t.logInfo("Worker terminated")};class j{get apiOrigin(){return this._apiOrigin}get clientId(){return this._clientId}get logger(){return this._logger}get metadata(){return this._metadata}get worker(){return this._worker}constructor(e,t,r,o,n){if(this.executeApiRequest=async(e,t="GET",r,o,n=!0,a=!1)=>{this._logger.logInfo("ExecuteApiRequest started",e,t,r,o);try{const a=await((e,t)=>async(r,o,n,a,c)=>{try{return await t.executeApiRequest(`${e}${r}`,o,n,a,c)}catch(e){let t;const{data:r,message:o,status:n}=e;throw t=e instanceof Error?new i(o,n):"Failed to refresh access token"===o?new s(o):new i(o,n),t.data=r,t}})(this._apiOrigin,this._worker)(e,t,r,o,n);return this._logger.logInfo("ExecuteApiRequest completed",a),a}catch(e){if(e instanceof i){const{data:t,message:r,name:o,stack:n}=e,i=this.getErrorMessageFromServerResponse(t);i&&(e.message=i,e.stack=null==n?void 0:n.replace(`${o}: ${r}`,`${o}: ${i}`))}throw a&&this.logger.logError(e),e}},!(t&&r&&o&&n))throw new c("Provider has not been properly initialized (call init to create new instances)");this._apiOrigin=null!=e?e:"",this._clientId=t,this._metadata=r,this._worker=o,this._logger=n,this.authorize=this.authorize.bind(this),this.close=this.close.bind(this),this.executeApiRequest=this.executeApiRequest.bind(this),this.expireTokens=this.expireTokens.bind(this),this.getErrorMessageFromServerResponse=this.getErrorMessageFromServerResponse.bind(this),this.getIdToken=this.getIdToken.bind(this)}async authorize(e,t,r){this._logger.logInfo("Authorize started",e,t,r);try{await(o=this._metadata,i=this._clientId,s=this._worker,c=this._logger,async(e,t={},r={})=>{const{authorization_endpoint:n}=o,a=fin.Application.getCurrentSync(),d=(await a.getChildWindows()).find(e=>e.identity.name===h);d&&await d.close(!0);const l=u(),p=(()=>{const e=new Uint32Array(64);return window.crypto.getRandomValues(e),Array.from(e,e=>`0${e.toString(16)}`.slice(-2)).join("")})(),f=(await(async e=>{const t=(new TextEncoder).encode(e),r=await window.crypto.subtle.digest("SHA-256",t),o=await(e=>new Promise((t,r)=>{try{const o=new Blob([e]),n=new FileReader;n.onload=e=>{var o,n;const i=null===(o=e.target)||void 0===o?void 0:o.result;if(i){const[,e]=Array.from(null!==(n=i.match(/base64,(.*)$/i))&&void 0!==n?n:[]);t(null!=e?e:"")}r(new Error("Unexpected empty result"))},n.readAsDataURL(o)}catch(e){r(e)}}))(r);return o.replace(/\+/g,"-").replace(/\//g,"_")})(p)).replace(/=+$/,""),m=new URL(n);m.searchParams.set("client_id",i),m.searchParams.set("redirect_uri",e),m.searchParams.set("response_type","code"),m.searchParams.set("state",l),m.searchParams.set("code_challenge",f),m.searchParams.set("code_challenge_method","S256"),Object.entries(t).forEach(e=>m.searchParams.set(e[0],e[1])),c.logInfo("Starting OAuth flow",m,r);const y=await g(m.toString(),w(l,e,c),r);c.logInfo("Received authorization code"),await s.exchangeCodeForTokens(y,p,e),c.logInfo("Received tokens")})(e,t,r),this._logger.logInfo("Authorize completed")}catch(e){let t;if(e instanceof n){const{data:r}=e,o=this.getErrorMessageFromServerResponse(r);t=new a(o,e),t.data=r}else t=new a(void 0,e);throw this.logger.logError(t),t}var o,i,s,c}async close(){var e;this._logger.logInfo("Close started");try{await(null===(e=this._worker)||void 0===e?void 0:e.terminate()),this._worker=void 0,this._apiOrigin=void 0,this._clientId=void 0,this._metadata=void 0,this._logger.logInfo("Close completed")}catch(e){const t=new n(void 0,e);throw this._logger.logError(t),t}}async expireTokens(e=!1){var t;this._logger.logInfo("ExpireTokens started");try{await(null===(t=this._worker)||void 0===t?void 0:t.expireTokens(e)),this._logger.logInfo("ExpireTokens completed")}catch(e){const t=new n(void 0,e);throw this._logger.logError(t),t}}getErrorMessageFromServerResponse(e){e&&this._logger.logWarning(e)}async getIdToken(){var e;this._logger.logInfo("GetIdToken started");try{const t=await(null===(e=this._worker)||void 0===e?void 0:e.getIdToken());return this._logger.logInfo("GetIdToken completed",t),t}catch(e){const t=new n(void 0,e);throw this._logger.logError(t),t}}static async init(e,t,r,o,...i){const a=new _(o);a.logInfo("Init started",e,t,r);try{let o;if("discoveryEndpoint"in e){const{additionalMetadata:t,discoveryEndpoint:r}=e;o=Object.assign(Object.assign({},await f(r)),null!=t?t:{})}else o=e;if(!o.response_types_supported.find(e=>"code"===e.toLowerCase()))throw new c("Authorization server does not support the authorization code response type");const n=await P(o,r,a),i=new j(t,r,o,n,a);return a.logInfo("Init completed",i),i}catch(e){let t;throw t=e instanceof n?e:new c(void 0,e),a.logError(t),t}}}const U=e=>async(t,r,o)=>{let n;null==e||e.logInfo("Validating token against introspection endpoint",t,r,o);try{n=await fetch(o,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`token=${t}&client_id=${r}`})}catch(e){throw new l(void 0,e)}if(n.ok){const t=await n.json(),{active:r}=t,o=function(e,t){var r={};for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&t.indexOf(o)<0&&(r[o]=e[o]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(o=Object.getOwnPropertySymbols(e);n<o.length;n++)t.indexOf(o[n])<0&&Object.prototype.propertyIsEnumerable.call(e,o[n])&&(r[o[n]]=e[o[n]])}return r}(t,["active"]),i=Object.assign({valid:r},o);return null==e||e.logInfo("Token validation result",i),i}const i=await n.json();throw null==e||e.logWarning("Token Validation failed",i),new l};var $=o.MS,K=o.cX,D=o.Yd,J=o.O4,H=o._W,L=o.p8,M=o.m$,N=o.U$,F=o.U7,z=o.OV,q=o.N7,G=o.Rp;const V=new TextEncoder,B=new TextDecoder,X=e=>{let t=e;t instanceof Uint8Array&&(t=B.decode(t)),t=t.replace(/-/g,"+").replace(/_/g,"/").replace(/\s/g,"");try{return(e=>{const t=atob(e),r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e);return r})(t)}catch(e){throw new TypeError("The input to be decoded is not correctly encoded.")}};class Y extends Error{static get code(){return"ERR_JOSE_GENERIC"}constructor(e){var t;super(e),this.code="ERR_JOSE_GENERIC",this.name=this.constructor.name,null===(t=Error.captureStackTrace)||void 0===t||t.call(Error,this,this.constructor)}}class Q extends Y{static get code(){return"ERR_JWT_CLAIM_VALIDATION_FAILED"}constructor(e,t="unspecified",r="unspecified"){super(e),this.code="ERR_JWT_CLAIM_VALIDATION_FAILED",this.claim=t,this.reason=r}}class Z extends Y{static get code(){return"ERR_JWT_EXPIRED"}constructor(e,t="unspecified",r="unspecified"){super(e),this.code="ERR_JWT_EXPIRED",this.claim=t,this.reason=r}}class ee extends Y{constructor(){super(...arguments),this.code="ERR_JOSE_ALG_NOT_ALLOWED"}static get code(){return"ERR_JOSE_ALG_NOT_ALLOWED"}}class te extends Y{constructor(){super(...arguments),this.code="ERR_JOSE_NOT_SUPPORTED"}static get code(){return"ERR_JOSE_NOT_SUPPORTED"}}class re extends Y{constructor(){super(...arguments),this.code="ERR_JWS_INVALID"}static get code(){return"ERR_JWS_INVALID"}}class oe extends Y{constructor(){super(...arguments),this.code="ERR_JWT_INVALID"}static get code(){return"ERR_JWT_INVALID"}}class ne extends Y{constructor(){super(...arguments),this.code="ERR_JWKS_INVALID"}static get code(){return"ERR_JWKS_INVALID"}}class ie extends Y{constructor(){super(...arguments),this.code="ERR_JWKS_NO_MATCHING_KEY",this.message="no applicable key found in the JSON Web Key Set"}static get code(){return"ERR_JWKS_NO_MATCHING_KEY"}}class ae extends Y{constructor(){super(...arguments),this.code="ERR_JWKS_MULTIPLE_MATCHING_KEYS",this.message="multiple matching keys found in the JSON Web Key Set"}static get code(){return"ERR_JWKS_MULTIPLE_MATCHING_KEYS"}}Symbol.asyncIterator;class se extends Y{constructor(){super(...arguments),this.code="ERR_JWKS_TIMEOUT",this.message="request timed out"}static get code(){return"ERR_JWKS_TIMEOUT"}}class ce extends Y{constructor(){super(...arguments),this.code="ERR_JWS_SIGNATURE_VERIFICATION_FAILED",this.message="signature verification failed"}static get code(){return"ERR_JWS_SIGNATURE_VERIFICATION_FAILED"}}const de=crypto,le=e=>e instanceof CryptoKey;de.getRandomValues.bind(de);const ue=async e=>{var t,r;if(!e.alg)throw new TypeError('"alg" argument is required when "jwk.alg" is not present');const{algorithm:o,keyUsages:n}=function(e){let t,r;switch(e.kty){case"oct":switch(e.alg){case"HS256":case"HS384":case"HS512":t={name:"HMAC",hash:`SHA-${e.alg.slice(-3)}`},r=["sign","verify"];break;case"A128CBC-HS256":case"A192CBC-HS384":case"A256CBC-HS512":throw new te(`${e.alg} keys cannot be imported as CryptoKey instances`);case"A128GCM":case"A192GCM":case"A256GCM":case"A128GCMKW":case"A192GCMKW":case"A256GCMKW":t={name:"AES-GCM"},r=["encrypt","decrypt"];break;case"A128KW":case"A192KW":case"A256KW":t={name:"AES-KW"},r=["wrapKey","unwrapKey"];break;case"PBES2-HS256+A128KW":case"PBES2-HS384+A192KW":case"PBES2-HS512+A256KW":t={name:"PBKDF2"},r=["deriveBits"];break;default:throw new te('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"RSA":switch(e.alg){case"PS256":case"PS384":case"PS512":t={name:"RSA-PSS",hash:`SHA-${e.alg.slice(-3)}`},r=e.d?["sign"]:["verify"];break;case"RS256":case"RS384":case"RS512":t={name:"RSASSA-PKCS1-v1_5",hash:`SHA-${e.alg.slice(-3)}`},r=e.d?["sign"]:["verify"];break;case"RSA-OAEP":case"RSA-OAEP-256":case"RSA-OAEP-384":case"RSA-OAEP-512":t={name:"RSA-OAEP",hash:`SHA-${parseInt(e.alg.slice(-3),10)||1}`},r=e.d?["decrypt","unwrapKey"]:["encrypt","wrapKey"];break;default:throw new te('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"EC":switch(e.alg){case"ES256":t={name:"ECDSA",namedCurve:"P-256"},r=e.d?["sign"]:["verify"];break;case"ES384":t={name:"ECDSA",namedCurve:"P-384"},r=e.d?["sign"]:["verify"];break;case"ES512":t={name:"ECDSA",namedCurve:"P-521"},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:"ECDH",namedCurve:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new te('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;case"OKP":switch(e.alg){case"EdDSA":t={name:e.crv},r=e.d?["sign"]:["verify"];break;case"ECDH-ES":case"ECDH-ES+A128KW":case"ECDH-ES+A192KW":case"ECDH-ES+A256KW":t={name:e.crv},r=e.d?["deriveBits"]:[];break;default:throw new te('Invalid or unsupported JWK "alg" (Algorithm) Parameter value')}break;default:throw new te('Invalid or unsupported JWK "kty" (Key Type) Parameter value')}return{algorithm:t,keyUsages:r}}(e),i=[o,null!==(t=e.ext)&&void 0!==t&&t,null!==(r=e.key_ops)&&void 0!==r?r:n];if("PBKDF2"===o.name)return de.subtle.importKey("raw",X(e.k),...i);const a={...e};return delete a.alg,delete a.use,de.subtle.importKey("jwk",a,...i)};function he(e){if("object"!=typeof(t=e)||null===t||"[object Object]"!==Object.prototype.toString.call(e))return!1;var t;if(null===Object.getPrototypeOf(e))return!0;let r=e;for(;null!==Object.getPrototypeOf(r);)r=Object.getPrototypeOf(r);return Object.getPrototypeOf(e)===r}function pe(e,t="algorithm.name"){return new TypeError(`CryptoKey does not support this operation, its ${t} must be ${e}`)}function ge(e,t){return e.name===t}function we(e){return parseInt(e.name.slice(4),10)}function fe(e,t,...r){if(r.length>2){const t=r.pop();e+=`one of type ${r.join(", ")}, or ${t}.`}else 2===r.length?e+=`one of type ${r[0]} or ${r[1]}.`:e+=`of type ${r[0]}.`;return null==t?e+=` Received ${t}`:"function"==typeof t&&t.name?e+=` Received function ${t.name}`:"object"==typeof t&&null!=t&&t.constructor&&t.constructor.name&&(e+=` Received an instance of ${t.constructor.name}`),e}Symbol();const me=(e,...t)=>fe("Key must be ",e,...t);function ye(e,t,...r){return fe(`Key for the ${e} algorithm must be `,t,...r)}const ve=e=>le(e),be=["CryptoKey"];async function _e(e,t,r){if(e instanceof Uint8Array&&(e=B.decode(e)),"string"!=typeof e)throw new re("Compact JWS must be a string or Uint8Array");const{0:o,1:n,2:i,length:a}=e.split(".");if(3!==a)throw new re("Invalid Compact JWS");const s=await async function(e,t,r){var o;if(!he(e))throw new re("Flattened JWS must be an object");if(void 0===e.protected&&void 0===e.header)throw new re('Flattened JWS must have either of the "protected" or "header" members');if(void 0!==e.protected&&"string"!=typeof e.protected)throw new re("JWS Protected Header incorrect type");if(void 0===e.payload)throw new re("JWS Payload missing");if("string"!=typeof e.signature)throw new re("JWS Signature missing or incorrect type");if(void 0!==e.header&&!he(e.header))throw new re("JWS Unprotected Header incorrect type");let n={};if(e.protected)try{const t=X(e.protected);n=JSON.parse(B.decode(t))}catch(e){throw new re("JWS Protected Header is invalid")}if(!((...e)=>{const t=e.filter(Boolean);if(0===t.length||1===t.length)return!0;let r;for(const e of t){const t=Object.keys(e);if(r&&0!==r.size)for(const e of t){if(r.has(e))return!1;r.add(e)}else r=new Set(t)}return!0})(n,e.header))throw new re("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");const i={...n,...e.header};let a=!0;if(function(e,t,r,o,n){if(void 0!==n.crit&&void 0===o.crit)throw new e('"crit" (Critical) Header Parameter MUST be integrity protected');if(!o||void 0===o.crit)return new Set;if(!Array.isArray(o.crit)||0===o.crit.length||o.crit.some(e=>"string"!=typeof e||0===e.length))throw new e('"crit" (Critical) Header Parameter MUST be an array of non-empty strings when present');let i;i=void 0!==r?new Map([...Object.entries(r),...t.entries()]):t;for(const t of o.crit){if(!i.has(t))throw new te(`Extension Header Parameter "${t}" is not recognized`);if(void 0===n[t])throw new e(`Extension Header Parameter "${t}" is missing`);if(i.get(t)&&void 0===o[t])throw new e(`Extension Header Parameter "${t}" MUST be integrity protected`)}return new Set(o.crit)}(re,new Map([["b64",!0]]),null==r?void 0:r.crit,n,i).has("b64")&&(a=n.b64,"boolean"!=typeof a))throw new re('The "b64" (base64url-encode payload) Header Parameter must be a boolean');const{alg:s}=i;if("string"!=typeof s||!s)throw new re('JWS "alg" (Algorithm) Header Parameter missing or invalid');const c=r&&((e,t)=>{if(void 0!==t&&(!Array.isArray(t)||t.some(e=>"string"!=typeof e)))throw new TypeError('"algorithms" option must be an array of strings');if(t)return new Set(t)})(0,r.algorithms);if(c&&!c.has(s))throw new ee('"alg" (Algorithm) Header Parameter not allowed');if(a){if("string"!=typeof e.payload)throw new re("JWS Payload must be a string")}else if("string"!=typeof e.payload&&!(e.payload instanceof Uint8Array))throw new re("JWS Payload must be a string or an Uint8Array instance");let d=!1;"function"==typeof t&&(t=await t(n,e),d=!0),((e,t)=>{e.startsWith("HS")||"dir"===e||e.startsWith("PBES2")||/^A\d{3}(?:GCM)?KW$/.test(e)?((e,t)=>{if(!(t instanceof Uint8Array)){if(!ve(t))throw new TypeError(ye(e,t,...be,"Uint8Array"));if("secret"!==t.type)throw new TypeError(`${be.join(" or ")} instances for symmetric algorithms must be of type "secret"`)}})(e,t):((e,t)=>{if(!ve(t))throw new TypeError(ye(e,t,...be));if("secret"===t.type)throw new TypeError(`${be.join(" or ")} instances for asymmetric algorithms must not be of type "secret"`);if(t.algorithm&&"private"===t.type)throw new TypeError(`${be.join(" or ")} instances for asymmetric algorithm verifying must be of type "public"`);t.algorithm})(e,t)})(s,t);const l=function(...e){const t=e.reduce((e,{length:t})=>e+t,0),r=new Uint8Array(t);let o=0;return e.forEach(e=>{r.set(e,o),o+=e.length}),r}(V.encode(null!==(o=e.protected)&&void 0!==o?o:""),V.encode("."),"string"==typeof e.payload?V.encode(e.payload):e.payload),u=X(e.signature);if(!await(async(e,t,r,o)=>{const n=await function(e,t,r){if(le(t))return function(e,t,...r){switch(t){case"HS256":case"HS384":case"HS512":{if(!ge(e.algorithm,"HMAC"))throw pe("HMAC");const r=parseInt(t.slice(2),10);if(we(e.algorithm.hash)!==r)throw pe(`SHA-${r}`,"algorithm.hash");break}case"RS256":case"RS384":case"RS512":{if(!ge(e.algorithm,"RSASSA-PKCS1-v1_5"))throw pe("RSASSA-PKCS1-v1_5");const r=parseInt(t.slice(2),10);if(we(e.algorithm.hash)!==r)throw pe(`SHA-${r}`,"algorithm.hash");break}case"PS256":case"PS384":case"PS512":{if(!ge(e.algorithm,"RSA-PSS"))throw pe("RSA-PSS");const r=parseInt(t.slice(2),10);if(we(e.algorithm.hash)!==r)throw pe(`SHA-${r}`,"algorithm.hash");break}case"EdDSA":if("Ed25519"!==e.algorithm.name&&"Ed448"!==e.algorithm.name)throw pe("Ed25519 or Ed448");break;case"ES256":case"ES384":case"ES512":{if(!ge(e.algorithm,"ECDSA"))throw pe("ECDSA");const r=function(e){switch(e){case"ES256":return"P-256";case"ES384":return"P-384";case"ES512":return"P-521";default:throw new Error("unreachable")}}(t);if(e.algorithm.namedCurve!==r)throw pe(r,"algorithm.namedCurve");break}default:throw new TypeError("CryptoKey does not support this operation")}!function(e,t){if(t.length&&!t.some(t=>e.usages.includes(t))){let e="CryptoKey does not support this operation, its usages must include ";if(t.length>2){const r=t.pop();e+=`one of ${t.join(", ")}, or ${r}.`}else 2===t.length?e+=`one of ${t[0]} or ${t[1]}.`:e+=`${t[0]}.`;throw new TypeError(e)}}(e,r)}(t,e,r),t;if(t instanceof Uint8Array){if(!e.startsWith("HS"))throw new TypeError(me(t,...be));return de.subtle.importKey("raw",t,{hash:`SHA-${e.slice(-3)}`,name:"HMAC"},!1,[r])}throw new TypeError(me(t,...be,"Uint8Array"))}(e,t,"verify");((e,t)=>{if(e.startsWith("RS")||e.startsWith("PS")){const{modulusLength:r}=t.algorithm;if("number"!=typeof r||r<2048)throw new TypeError(`${e} requires key modulusLength to be 2048 bits or larger`)}})(e,n);const i=function(e,t){const r=`SHA-${e.slice(-3)}`;switch(e){case"HS256":case"HS384":case"HS512":return{hash:r,name:"HMAC"};case"PS256":case"PS384":case"PS512":return{hash:r,name:"RSA-PSS",saltLength:e.slice(-3)>>3};case"RS256":case"RS384":case"RS512":return{hash:r,name:"RSASSA-PKCS1-v1_5"};case"ES256":case"ES384":case"ES512":return{hash:r,name:"ECDSA",namedCurve:t.namedCurve};case"EdDSA":return{name:t.name};default:throw new te(`alg ${e} is not supported either by JOSE or your javascript runtime`)}}(e,n.algorithm);try{return await de.subtle.verify(i,n,r,o)}catch(e){return!1}})(s,t,u,l))throw new ce;let h;h=a?X(e.payload):"string"==typeof e.payload?V.encode(e.payload):e.payload;const p={payload:h};return void 0!==e.protected&&(p.protectedHeader=n),void 0!==e.header&&(p.unprotectedHeader=e.header),d?{...p,key:t}:p}({payload:n,protected:o,signature:i},t,r),c={payload:s.payload,protectedHeader:s.protectedHeader};return"function"==typeof t?{...c,key:s.key}:c}const Se=/^(\d+|\d+\.\d+) ?(seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)$/i,Ee=e=>{const t=Se.exec(e);if(!t)throw new TypeError("Invalid time period format");const r=parseFloat(t[1]);switch(t[2].toLowerCase()){case"sec":case"secs":case"second":case"seconds":case"s":return Math.round(r);case"minute":case"minutes":case"min":case"mins":case"m":return Math.round(60*r);case"hour":case"hours":case"hr":case"hrs":case"h":return Math.round(3600*r);case"day":case"days":case"d":return Math.round(86400*r);case"week":case"weeks":case"w":return Math.round(604800*r);default:return Math.round(31557600*r)}},Ie=e=>e.toLowerCase().replace(/^application\//,""),ke=(e,t,r={})=>{const{typ:o}=r;if(o&&("string"!=typeof e.typ||Ie(e.typ)!==Ie(o)))throw new Q('unexpected "typ" JWT header value',"typ","check_failed");let n;try{n=JSON.parse(B.decode(t))}catch(e){}if(!he(n))throw new oe("JWT Claims Set must be a top-level JSON object");const{requiredClaims:i=[],issuer:a,subject:s,audience:c,maxTokenAge:d}=r;void 0!==d&&i.push("iat"),void 0!==c&&i.push("aud"),void 0!==s&&i.push("sub"),void 0!==a&&i.push("iss");for(const e of new Set(i.reverse()))if(!(e in n))throw new Q(`missing required "${e}" claim`,e,"missing");if(a&&!(Array.isArray(a)?a:[a]).includes(n.iss))throw new Q('unexpected "iss" claim value',"iss","check_failed");if(s&&n.sub!==s)throw new Q('unexpected "sub" claim value',"sub","check_failed");if(c&&(u="string"==typeof c?[c]:c,!("string"==typeof(l=n.aud)?u.includes(l):Array.isArray(l)&&u.some(Set.prototype.has.bind(new Set(l))))))throw new Q('unexpected "aud" claim value',"aud","check_failed");var l,u;let h;switch(typeof r.clockTolerance){case"string":h=Ee(r.clockTolerance);break;case"number":h=r.clockTolerance;break;case"undefined":h=0;break;default:throw new TypeError("Invalid clockTolerance option type")}const{currentDate:p}=r,g=(w=p||new Date,Math.floor(w.getTime()/1e3));var w;if((void 0!==n.iat||d)&&"number"!=typeof n.iat)throw new Q('"iat" claim must be a number',"iat","invalid");if(void 0!==n.nbf){if("number"!=typeof n.nbf)throw new Q('"nbf" claim must be a number',"nbf","invalid");if(n.nbf>g+h)throw new Q('"nbf" claim timestamp check failed',"nbf","check_failed")}if(void 0!==n.exp){if("number"!=typeof n.exp)throw new Q('"exp" claim must be a number',"exp","invalid");if(n.exp<=g-h)throw new Z('"exp" claim timestamp check failed',"exp","check_failed")}if(d){const e=g-n.iat;if(e-h>("number"==typeof d?d:Ee(d)))throw new Z('"iat" claim timestamp check failed (too far in the past)',"iat","check_failed");if(e<0-h)throw new Q('"iat" claim timestamp check failed (it should be in the past)',"iat","check_failed")}return n};function Ae(e){return e&&"object"==typeof e&&Array.isArray(e.keys)&&e.keys.every(Te)}function Te(e){return he(e)}class Re{constructor(e){if(this._cached=new WeakMap,!Ae(e))throw new ne("JSON Web Key Set malformed");var t;this._jwks=(t=e,"function"==typeof structuredClone?structuredClone(t):JSON.parse(JSON.stringify(t)))}async getKey(e,t){const{alg:r,kid:o}={...e,...null==t?void 0:t.header},n=function(e){switch("string"==typeof e&&e.slice(0,2)){case"RS":case"PS":return"RSA";case"ES":return"EC";case"Ed":return"OKP";default:throw new te('Unsupported "alg" value for a JSON Web Key Set')}}(r),i=this._jwks.keys.filter(e=>{let t=n===e.kty;if(t&&"string"==typeof o&&(t=o===e.kid),t&&"string"==typeof e.alg&&(t=r===e.alg),t&&"string"==typeof e.use&&(t="sig"===e.use),t&&Array.isArray(e.key_ops)&&(t=e.key_ops.includes("verify")),t&&"EdDSA"===r&&(t="Ed25519"===e.crv||"Ed448"===e.crv),t)switch(r){case"ES256":t="P-256"===e.crv;break;case"ES256K":t="secp256k1"===e.crv;break;case"ES384":t="P-384"===e.crv;break;case"ES512":t="P-521"===e.crv}return t}),{0:a,length:s}=i;if(0===s)throw new ie;if(1!==s){const e=new ae,{_cached:t}=this;throw e[Symbol.asyncIterator]=async function*(){for(const e of i)try{yield await Oe(t,e,r)}catch(e){continue}},e}return Oe(this._cached,a,r)}}async function Oe(e,t,r){const o=e.get(t)||e.set(t,{}).get(t);if(void 0===o[r]){const e=await async function(e,t,r){var o;if(!he(e))throw new TypeError("JWK must be an object");switch(t||(t=e.alg),e.kty){case"oct":if("string"!=typeof e.k||!e.k)throw new TypeError('missing "k" (Key Value) Parameter value');return null!=r||(r=!0!==e.ext),r?ue({...e,alg:t,ext:null!==(o=e.ext)&&void 0!==o&&o}):X(e.k);case"RSA":if(void 0!==e.oth)throw new te('RSA JWK "oth" (Other Primes Info) Parameter value is not supported');case"EC":case"OKP":return ue({...e,alg:t});default:throw new te('Unsupported "kty" (Key Type) Parameter value')}}({...t,ext:!0},r);if(e instanceof Uint8Array||"public"!==e.type)throw new ne("JSON Web Key Set members must be public keys");o[r]=e}return o[r]}class Pe extends Re{constructor(e,t){if(super({keys:[]}),this._jwks=void 0,!(e instanceof URL))throw new TypeError("url must be an instance of URL");this._url=new URL(e.href),this._options={agent:null==t?void 0:t.agent,headers:null==t?void 0:t.headers},this._timeoutDuration="number"==typeof(null==t?void 0:t.timeoutDuration)?null==t?void 0:t.timeoutDuration:5e3,this._cooldownDuration="number"==typeof(null==t?void 0:t.cooldownDuration)?null==t?void 0:t.cooldownDuration:3e4,this._cacheMaxAge="number"==typeof(null==t?void 0:t.cacheMaxAge)?null==t?void 0:t.cacheMaxAge:6e5}coolingDown(){return"number"==typeof this._jwksTimestamp&&Date.now()<this._jwksTimestamp+this._cooldownDuration}fresh(){return"number"==typeof this._jwksTimestamp&&Date.now()<this._jwksTimestamp+this._cacheMaxAge}async getKey(e,t){this._jwks&&this.fresh()||await this.reload();try{return await super.getKey(e,t)}catch(r){if(r instanceof ie&&!1===this.coolingDown())return await this.reload(),super.getKey(e,t);throw r}}async reload(){this._pendingFetch&&("undefined"!=typeof WebSocketPair||"undefined"!=typeof navigator&&"Cloudflare-Workers"===navigator.userAgent||"undefined"!=typeof EdgeRuntime&&"vercel"===EdgeRuntime)&&(this._pendingFetch=void 0),this._pendingFetch||(this._pendingFetch=(async(e,t,r)=>{let o,n,i=!1;"function"==typeof AbortController&&(o=new AbortController,n=setTimeout(()=>{i=!0,o.abort()},t));const a=await fetch(e.href,{signal:o?o.signal:void 0,redirect:"manual",headers:r.headers}).catch(e=>{if(i)throw new se;throw e});if(void 0!==n&&clearTimeout(n),200!==a.status)throw new Y("Expected 200 OK from the JSON Web Key Set HTTP response");try{return await a.json()}catch(e){throw new Y("Failed to parse the JSON Web Key Set HTTP response as JSON")}})(this._url,this._timeoutDuration,this._options).then(e=>{if(!Ae(e))throw new ne("JSON Web Key Set malformed");this._jwks={keys:e.keys},this._jwksTimestamp=Date.now(),this._pendingFetch=void 0}).catch(e=>{throw this._pendingFetch=void 0,e})),await this._pendingFetch}}const Ce=X;class xe extends ${constructor(e,t){super(e=e??t?.message??"An error occurred during authentication",t)}}class We extends ${constructor(e,t){super(e=e??t?.message??"An error occurred during logout",t)}}const je="1.0.0",Ue="OIDC",$e=()=>{N(Ue)},Ke=()=>{F(Ue,je)};"undefined"!=typeof window&&("undefined"==typeof fin&&Object.assign(window,{fin:{}}),Object.assign(fin,{Integrations:{OIDC:{enableLogging:Ke,disableLogging:$e}}}));const De=e=>`${e.replace(/\/$/,"")}/.well-known/openid-configuration`;var Je;(Je||(Je={})).OpenIdConnect="OpenID-Connect";class He extends J{get idToken(){return this._idToken}get openIdProviderUrl(){return this._openIdProviderUrl}get redirectUri(){return this._redirectUri}get scope(){return this._scope}get userInfo(){return this._userInfo}async authorize(e,t,r){await super.authorize(e,t,r),this._idToken=await this.getIdToken(),this._userInfo=await(async e=>{const t=e.metadata?.userinfo_endpoint;if(!t)return;const{data:r}=await e.executeApiRequest(t);return r})(this)}async close(){await super.close(),this._idToken=void 0,this._openIdProviderUrl=void 0,this._redirectUri=void 0,this._scope=void 0,this._userInfo=void 0}getErrorMessageFromServerResponse(e){return e}static async init(e,t,r,o,n,i,a){const s=new D(o);s.logInfo("Init started",e,t,r,o,n,i,a);try{const{additionalMetadata:t,discoveryEndpoint:o}=e,c={...await z(o),...t??{}};if(!c.response_types_supported.find(e=>"code"===e.toLowerCase()))throw new K("OpenID Provider does not support the authorization code response type");const d=await q(c,r,s),l=new He(void 0,r,c,d,s);return l._openIdProviderUrl=n,l._redirectUri=i,l._scope=a,s.logInfo("Init completed",l),(async(e,t)=>{try{await fin.System.registerUsage({type:"integration-feature",data:{apiVersion:je,componentName:e}})}catch(r){t.logWarning(`Unable to register usage for feature ${e}: ${r?.message}`)}})(Je.OpenIdConnect,s),l}catch(e){let t;throw t=e instanceof $?e:new K(void 0,e),s.logError(t),t}}}const Le=async(e,t,r)=>{const o=new D(Ue),n=De(r);let i;try{i=await z(n)}catch(e){const t=new L(`Failed to retrieve OpenID Connect metadata from ${n}`);throw o.logError(t),t}const{introspection_endpoint:a,jwks_uri:s}=i;if(a)try{return await G(o)(e,t,a)}catch(e){}else o?.logWarning("No introspection endpoint found in OpenID Connect metadata");if(!s){const e=new L(`Failed to retrieve JSON Web Key Set (JWKS) from ${s}`);throw o.logError(e),e}o?.logInfo("Validating id token against JWKS endpoint",s);try{const{payload:n}=await async function(e,t,r){var o;const n=await _e(e,t,r);if((null===(o=n.protectedHeader.crit)||void 0===o?void 0:o.includes("b64"))&&!1===n.protectedHeader.b64)throw new oe("JWTs MUST NOT use unencoded payload");const i={payload:ke(n.protectedHeader,n.payload,r),protectedHeader:n.protectedHeader};return"function"==typeof t?{...i,key:n.key}:i}(e,function(e){const t=new Pe(e,void 0);return async function(e,r){return t.getKey(e,r)}}(new URL(s)),{audience:t,issuer:r});return o?.logInfo("ID token validation successful",n),{valid:!0,...n}}catch(e){if(!(e instanceof Q||e instanceof Z||e instanceof oe||e instanceof ce)){const t=new L(void 0,e);throw o.logError(t),t}return o.logWarning(`ID token validation failed: ${e.message}`),{valid:!1}}},Me=["openid","profile","email"],Ne=async(e,t,r,o=[],n,i,a)=>{if(e=e?.trim().replace(/\/$/,""),!e)throw new H("OpenID Provider URL must be a non-empty string");if(!t)throw new H("Client Identifier must be a non-empty string");if(!r)throw new H("Redirection URI must be a non-empty string");const s=await ze(e,t,r,o,n);if(!s)throw new K("Provider not initialized");const c=s.metadata?.scopes_supported;if(!c){const e=new xe("OpenID Provider metadata does not define supported scopes");throw s.logger.logError(e),e}const d=Me.filter(e=>!c.includes(e));if(d.length>0){const e=new xe(`OpenID Provider does not support required scopes: ${d.join(", ")}`);throw s.logger.logError(e),e}const l=new Set([...Me,...o]);await s.authorize(r,{display:"popup",scope:[...l].join(" "),...i},a);const{idToken:u}=s;if(!u){const e=new xe("No ID token returned");throw s.logger.logError(e),e}const h=function(e){if("string"!=typeof e)throw new oe("JWTs must use Compact JWS serialization, JWT must be a string");const{1:t,length:r}=e.split(".");if(5===r)throw new oe("Only JWTs using Compact JWS serialization can be decoded");if(3!==r)throw new oe("Invalid JWT");if(!t)throw new oe("JWTs must contain a payload");let o,n;try{o=Ce(t)}catch(e){throw new oe("Failed to parse the base64url encoded payload")}try{n=JSON.parse(B.decode(o))}catch(e){throw new oe("Failed to parse the decoded payload as JSON")}if(!he(n))throw new oe("Invalid JWT Claims Set");return n}(u);if(!h){const e=new xe("Failed to decode ID token");throw s.logger.logError(e),e}const{aud:p,iss:g}=h;return await Le(u,Array.isArray(p)?p[0]:p,g),{claims:h,clientId:t,idToken:u,logout:qe(t,u,s),openIdProviderUrl:e,userInfo:s.userInfo}},Fe=(e,t,r,o,n,i)=>async n=>{if(0!==new URL(n).href.toLowerCase().indexOf(r.toLowerCase()))return!1;window.clearInterval(i),window.clearTimeout(t);try{e.removeAllListeners(),e.close(!0)}catch(e){}return o(),!0},ze=async(e,t,r,o,n)=>{const i={additionalMetadata:n,discoveryEndpoint:De(e)};return He.init(i,void 0,t,Ue,e,r,o)},qe=(e,t,r)=>async(o,n)=>{if(!o)throw new H("Logout Redirection URI must be a non-empty string");const{logger:i,metadata:a}=r;i.logInfo("Logout started",e,t,o,n);const{end_session_endpoint:s}=a??{};if(!s){const e=new We("OpenID Provider metadata does not define end session endpoint");throw i.logError(e),e}const c=`${s}?id_token_hint=${t}&client_id=${e}&post_logout_redirect_uri=${encodeURIComponent(o)}${n?`&logout_hint=${encodeURIComponent(n)}`:""}`;await M(c,Ge(o,i)),await(r?.close()),i.logInfo("Logout completed")},Ge=(e,t)=>r=>new Promise((o,n)=>{let i;r.addListener("closing",async()=>{t.logInfo("User closed auth window"),window.clearInterval(i),r.removeAllListeners(),n(new We("Failed to complete logout process"))});const a=window.setTimeout(async()=>{try{await r.isShowing()||(t.logInfo("Showing auth window"),await r.show(!0),await r.focus())}catch{t.logWarning("Unable to show auth window")}},2e3);(async()=>{const{version:s}=await fin.System.getRuntimeInfo();parseInt(s.split(".")[0],10)>=30?await Fe(r,a,e,o)((await r.getInfo()).url)||await r.addListener("url-changed",n=>{t.logInfo("Auth window navigated to",n.url),Fe(r,a,e,o)(n.url)}):i=window.setInterval(()=>(async(e,t,r,o,n,i)=>{let a;try{a=await e.getInfo()}catch(e){return window.clearInterval(t),window.clearTimeout(r),i(new We("Could not locate auth window")),!1}return Fe(e,r,o,n,0,t)(a.url)})(r,i,a,e,o,n),500)})()});var Ve=t.YR,Be=t.U7,Xe=t.OF;function Ye(e){return null==e}function Qe(e){return null!=e&&"string"==typeof e}function Ze(e){return Qe(e)&&e.trim().length>0}function et(e){return Ye(e)?"":e instanceof Error?e.message:Ze(e)?e:null!=(t=e)&&"object"==typeof t&&!Array.isArray(t)&&"message"in e&&Qe(e.message)?e.message:JSON.stringify(e);var t}const tt={auth:new class{constructor(){this._subscribeIdMap={},this._eventSubscribers={}}async initialize(e,t,r){this._definition=e,this._logger=t("OpenIdConnectProvider"),this._logger.info("Initializing"),this._definition.data?.enableLogging&&Be();const o=this._definition.data?.providerUrl,n=this._definition.data?.clientId,i=this._definition.data?.loginRedirectUrl,a=this._definition.data?.logoutRedirectUrl;Ze(o)||this._logger.error("providerUrl is not configured"),Ze(n)||this._logger.error("ClientId is not configured"),Ze(i)||this._logger.error("loginRedirectUrl is not configured"),Ze(a)||this._logger.error("logoutRedirectUrl is not configured")}async closedown(){this._logger?.info("Closedown"),this._sessionExpiryTimerId&&(window.clearTimeout(this._sessionExpiryTimerId),this._sessionExpiryTimerId=void 0)}subscribe(e,t){const r="randomUUID"in globalThis.crypto?globalThis.crypto.randomUUID():"10000000-1000-4000-8000-100000000000".replace(/[018]/g,function(e){const t=globalThis.crypto.getRandomValues(new Uint8Array(1))[0]&15>>Number(e)/4;return(Number(e)^t).toString(16)}),o=this._eventSubscribers[e]??{};return o[r]=t,this._eventSubscribers[e]=o,this._subscribeIdMap[r]=e,this._logger?.info(`Subscription to ${e} events registered. Subscription Id: ${r}`),r}unsubscribe(e){const t=this._subscribeIdMap[e];if(Ye(t))return this._logger?.warn(`You have tried to unsubscribe with a key ${e} that is invalid`),!1;const r=this._eventSubscribers[t];return Ye(r)||delete r[e],this._subscribeIdMap[e]?(delete this._subscribeIdMap[e],this._logger?.info(`Subscription to ${t} events with subscription Id: ${e} has been cleared`),!0):(this._logger?.warn(`Subscription to ${t} events with subscription Id: ${e} could not be cleared as we do not have a register of that event type.`),!1)}async isAuthenticationRequired(){return Ye(this._authResult)}async login(){const e=this._definition?.data?.providerUrl,t=this._definition?.data?.clientId,r=this._definition?.data?.loginRedirectUrl,o=this._definition?.data?.scopes;if(Ze(e)&&Ze(t)&&Ze(r))try{return this._authResult=await Ve(e,t,r,o),await this.notifySubscribers("logged-in"),this.checkForSessionExpiry(),!0}catch(e){this._logger?.error("Authentication failed",et(e))}return!1}async logout(){if(this._authResult){this._sessionExpiryTimerId&&(window.clearTimeout(this._sessionExpiryTimerId),this._sessionExpiryTimerId=void 0);const e=this._definition?.data?.logoutRedirectUrl;if(Ze(e))try{await this.notifySubscribers("before-logged-out"),await this._authResult.logout(e)}catch(e){this._logger?.error("Logout failed",et(e))}finally{await this.notifySubscribers("logged-out")}this._authResult=void 0}return!0}async getUserInfo(){if(this._authResult)return this._authResult.userInfo}async notifySubscribers(e){const t=this._eventSubscribers[e];if(t){const r=Object.keys(t);r.reverse();for(const o of r)this._logger?.info(`Notifying subscriber with subscription Id: ${o} of event type: ${e}`),await t[o]()}}checkForSessionExpiry(){const e=this._definition?.data?.checkSessionValidityInSeconds;var t;null!=(t=e)&&"number"==typeof t&&e>0&&Ye(this._sessionExpiryTimerId)&&(this._sessionExpiryTimerId=window.setTimeout(async()=>{this._sessionExpiryTimerId=void 0;const e=this._authResult?.idToken,t=this._definition?.data?.providerUrl,r=this._definition?.data?.clientId;let o=!1;if(Ze(e)&&Ze(t)&&Ze(r))try{o=(await Xe(e,r,t)).valid}catch(e){this._logger?.error("Failed validating token",et(e))}o?(this._logger?.info("Session Still Active"),this.checkForSessionExpiry()):(this._logger?.info("Session not valid"),this._authResult=void 0,await this.notifySubscribers("session-expired"))},1e3*e))}}};export{tt as entryPoints};
//# sourceMappingURL=openid-connect.bundle.js.map