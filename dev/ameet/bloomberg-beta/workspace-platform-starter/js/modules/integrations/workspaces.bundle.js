const t="workspace";function e(t){return null==t}function i(t){return function(t){return null!=t&&"string"==typeof t}(t)&&t.trim().length>0}function a(){return"randomUUID"in globalThis.crypto?globalThis.crypto.randomUUID():"10000000-1000-4000-8000-100000000000".replace(/[018]/g,function(t){const e=globalThis.crypto.getRandomValues(new Uint8Array(1))[0]&15>>Number(t)/4;return(Number(t)^e).toString(16)})}class s{async initialize(i,a,s){this._settings=i.data,this._integrationHelpers=s,this._definition=i,this._logger=a("WorkspacesProvider"),this._integrationHelpers.subscribeLifecycleEvent&&(this._integrationHelpers.subscribeLifecycleEvent("workspace-changed",async(i,a)=>{if("create"===a?.action||"apply"===a?.action)e(this._lastQuery)||this._lastQuery.startsWith("/w ")||await this.rebuildResults(i);else if("update"===a?.action){const e=this._lastResults?.find(t=>t.key===a.id);if(e&&a.workspace){e.title=a.workspace.title,e.data.workspaceTitle=a.workspace.title,e.templateContent.data.title=a.workspace.title,this.resultAddUpdate([e]);const{favoriteClient:i}=await this.getFavInfo(t);if(i?.setSavedFavorite){const e=await i.getSavedFavorites(t),s=await(e?.find(t=>t.typeId===a.id));s&&(s.label=a.workspace.title,await i.setSavedFavorite(s))}}}else if("delete"===a?.action){this.resultRemove(a.id);const{favoriteClient:e}=await this.getFavInfo(t);if(e?.deleteSavedFavorite){const i=await e.getSavedFavorites(t),s=await(i?.find(t=>t.typeId===a.id));s&&await e.deleteSavedFavorite(s.id)}}}),this._themeChangedSubscriptionId=this._integrationHelpers.subscribeLifecycleEvent("theme-changed",async()=>{if(this._integrationHelpers?.getPlatform){const t=this._integrationHelpers.getPlatform();await this.rebuildResults(t)}}),this._favChangedSubscriptionId=this._integrationHelpers.subscribeLifecycleEvent("favorite-changed",async(t,i)=>{e(i)||await this.updateAppFavoriteButtons(i)}))}async closedown(){this._integrationHelpers?.unsubscribeLifecycleEvent&&(i(this._themeChangedSubscriptionId)&&(this._integrationHelpers.unsubscribeLifecycleEvent(this._themeChangedSubscriptionId,"theme-changed"),this._themeChangedSubscriptionId=void 0),i(this._favChangedSubscriptionId)&&(this._integrationHelpers.unsubscribeLifecycleEvent(this._favChangedSubscriptionId,"favorite-changed"),this._favChangedSubscriptionId=void 0))}async getHelpSearchEntries(){if(this._integrationHelpers&&this._settings){const t=await this._integrationHelpers.getThemeClient();return[{key:`${this._definition?.id}-help1`,score:this._definition?.baseScore??s._DEFAULT_BASE_SCORE,title:"Workspaces",label:"Help",icon:await t.themeUrl(this._settings.images.workspace),actions:[],data:{providerId:this._definition?.id},template:"Custom",templateContent:await this._integrationHelpers.templateHelpers.createHelp("Workspaces",["Use the workspaces command to save your current layout."],["/w title"])}]}return[]}async getSearchResults(e,n,o,r){if(this._integrationHelpers?.getPlatform&&this._settings){const n=await this._integrationHelpers.getThemeClient(),l=this._integrationHelpers.getPlatform(),c=e.toLowerCase(),p=r?.queryMinLength??3;let d=await l.Storage.getWorkspaces(),h=c;if(this._lastResponse=o,this._lastQuery=c,this._lastQueryMinLength=p,c.startsWith("/w ")){const t=c.replace("/w ",""),e=d.find(e=>e.title.toLowerCase()===t.toLowerCase());return e?{results:[{key:s._ACTION_EXISTS_WORKSPACE,score:this._definition?.baseScore??s._DEFAULT_BASE_SCORE,title:`Workspace ${e.title} already exists.`,icon:await n.themeUrl(this._settings.images.workspace),actions:[],data:{providerId:this._definition?.id,tags:["workspace"],workspaceId:e.workspaceId},template:"Plain",templateContent:void 0}]}:{results:[{key:s._ACTION_SAVE_WORKSPACE,score:this._definition?.baseScore??s._DEFAULT_BASE_SCORE,title:`Save Current Workspace as ${t}`,icon:await n.themeUrl(this._settings.images.workspace),label:"Suggestion",actions:[{name:"Save Workspace",hotkey:"Enter"}],data:{providerId:this._definition?.id,tags:["workspace"],workspaceId:a(),workspaceTitle:t},template:"Plain",templateContent:void 0}]}}const{favoriteClient:_,favoriteInfo:g}=await this.getFavInfo(t);if(g?.isEnabled&&i(g?.command)&&c===g.command&&_){const e=await _.getSavedFavorites(t),i=e?.map(t=>t.typeId)??[];d=d.filter(t=>i.includes(t.workspaceId)),h=""}const u=await this.buildResults(l,d,h,p);return this._lastResults=u,{results:u}}return{results:[]}}async itemSelection(i,n){let o=!1;if("user-action"===i.action.trigger)if(i.action.name.endsWith("favorite")&&i.data?.workspaceId){const{favoriteClient:s}=await this.getFavInfo(t);s&&(i.action.name.startsWith("un")?!e(i.data?.favoriteId)&&s.deleteSavedFavorite&&await s.deleteSavedFavorite(i.data.favoriteId):s.setSavedFavorite&&await s.setSavedFavorite({id:a(),type:t,typeId:i.key,label:i.title,icon:this._settings?.images.workspace}),o=!0)}else if(this._integrationHelpers?.getPlatform){const e=i.data;if(e?.workspaceId)if(o=!0,i.key===s._ACTION_SAVE_WORKSPACE){this.resultRemove(i.key);const a=this._integrationHelpers.getPlatform(),s=await a.getSnapshot(),n=await a.getCurrentWorkspace(),o=n?.metadata,r={workspaceId:e.workspaceId,title:e.workspaceTitle??"",metadata:o,snapshot:s};await a.Storage.saveWorkspace(r);let l=!1;if(this._integrationHelpers?.getShareClient){const t=await this._integrationHelpers.getShareClient();t&&(l=await t.typeEnabled("workspace"))}const{favoriteInfo:c}=await this.getFavInfo(t),p=await this.getWorkspaceTemplate(r.workspaceId,r.title,l,!0,c);this.resultAddUpdate([p])}else if(i.key===s._ACTION_EXISTS_WORKSPACE);else if(i.action.name===s._ACTION_OPEN_WORKSPACE){const t=this._integrationHelpers.getPlatform(),i=await t.Storage.getWorkspace(e.workspaceId);i?(await t.applyWorkspace(i),await this.rebuildResults(t)):this._logger?.warn(`Workspace not found: ${e.workspaceId}`)}else if(i.action.name===s._ACTION_DELETE_WORKSPACE){const t=this._integrationHelpers.getPlatform();await t.Storage.deleteWorkspace(e.workspaceId)}else if(i.action.name===s._ACTION_SHARE_WORKSPACE&&this._integrationHelpers.getShareClient){const t=await this._integrationHelpers.getShareClient();t&&await t.share("workspace",{workspaceId:e.workspaceId})}else o=!1,this._logger?.warn(`Unrecognized action for workspace selection: ${e.workspaceId}`)}return o}async getWorkspaceTemplate(t,i,a,n,o,r){if(this._integrationHelpers&&this._settings){const l=[{name:s._ACTION_OPEN_WORKSPACE,hotkey:"Enter"}],c=[{title:"Open",action:s._ACTION_OPEN_WORKSPACE}];let p;n?p="This is the currently active workspace. You can use the Browser menu to update/rename this workspace":(p="Use the buttons below to interact with your saved workspace",l.push({name:s._ACTION_DELETE_WORKSPACE,hotkey:"CmdOrCtrl+Shift+D"}),c.push({title:"Delete",action:s._ACTION_DELETE_WORKSPACE})),a&&(l.push({name:s._ACTION_SHARE_WORKSPACE,hotkey:"CmdOrCtrl+Shift+S"}),c.push({title:"Share",action:s._ACTION_SHARE_WORKSPACE}));const d=await this._integrationHelpers.getThemeClient(),h=await d.themeUrl(this._settings.images.workspace),_=[];if(o?.favoriteIcon&&o.unfavoriteIcon){const t=await d.themeUrl(e(r)?o.unfavoriteIcon:o.favoriteIcon);t&&_.push({icon:t,action:e(r)?"favorite":"unfavorite"})}const g=await this._integrationHelpers.templateHelpers.createLayout(i,h,[await this._integrationHelpers.templateHelpers.createText("instructions")],c,_);return{key:t,score:this._definition?.baseScore??s._DEFAULT_BASE_SCORE,title:i,label:"Workspace",icon:h,actions:l,data:{providerId:this._definition?.id,workspaceTitle:i,workspaceId:t,tags:["workspace"],favoriteId:r},template:"Custom",templateContent:{layout:g.layout,data:{...g.data,instructions:p}}}}return{key:t,score:this._definition?.baseScore??s._DEFAULT_BASE_SCORE,title:i,label:"Workspace",actions:[],data:{providerId:this._definition?.id,workspaceTitle:i,workspaceId:t,tags:["workspace"]},template:"Plain",templateContent:void 0}}async rebuildResults(t){if(this._integrationHelpers&&!e(this._lastQuery)&&!e(this._lastQueryMinLength)){const e=await t.Storage.getWorkspaces(),i=await this.buildResults(t,e,this._lastQuery,this._lastQueryMinLength);this.resultAddUpdate(i)}}async buildResults(e,i,a,s){let n=[];if(this._integrationHelpers&&Array.isArray(i)){const o=await e.getCurrentWorkspace(),r=o?.workspaceId;let l=!1;if(this._integrationHelpers?.getShareClient){const t=await this._integrationHelpers.getShareClient();t&&(l=await t.typeEnabled("workspace"))}const{favoriteClient:c,favoriteInfo:p}=await this.getFavInfo(t);let d;c&&(d=await c.getSavedFavorites(t));const h=i.filter(t=>0===a.length||a.length>=s&&t.title.toLowerCase().includes(a)).sort((t,e)=>t.title.localeCompare(e.title)).map(async t=>{const e=d?.find(e=>e.typeId===t.workspaceId)?.id;return this.getWorkspaceTemplate(t.workspaceId,t.title,l,r===t.workspaceId,p,e)});n=await Promise.all(h)}return n}resultAddUpdate(t){if(this._lastResults)for(const e of t){const t=this._lastResults.findIndex(t=>t.key===e.key);t>=0?this._lastResults.splice(t,1,e):this._lastResults.push(e)}this._lastResponse&&this._lastResponse.respond(t)}resultRemove(t){if(this._lastResults){const e=this._lastResults.findIndex(e=>e.key===t);e>=0&&this._lastResults.splice(e,1)}this._lastResponse&&this._lastResponse.revoke(t)}async updateAppFavoriteButtons(i){const a=i.favorite;if(!e(this._lastResponse)&&this._integrationHelpers?.getPlatform&&("set"===i.action||"delete"===i.action)&&!e(a)&&a.type===t&&this._lastResults){const{favoriteInfo:s}=await this.getFavInfo(t);if(this._lastQuery===s?.command&&"delete"===i.action)this._lastResponse.revoke(a.typeId);else if(this._lastResults){const t=this._lastResults.find(t=>t.key===a.typeId);if(!e(t)){let e=!1;if(this._integrationHelpers?.getConditionsClient){const t=await this._integrationHelpers.getConditionsClient();t&&(e=await t.check("sharing"))}const n=this._integrationHelpers.getPlatform(),o=await n.getCurrentWorkspace(),r=o?.workspaceId,l=await this.getWorkspaceTemplate(t.key,t.title,e,r===t.key,s,"set"===i.action?a.id:void 0);this._lastResponse.respond([l])}}}}async getFavInfo(t){let e,i;return(this._definition?.data?.favoritesEnabled??1)&&this._integrationHelpers?.getFavoriteClient&&(i=await this._integrationHelpers.getFavoriteClient(),i&&(e=i.getInfo(),e.isEnabled))&&((e?.enabledTypes?.includes(t)??1)||(e=void 0,i=void 0)),{favoriteClient:i,favoriteInfo:e}}}s._DEFAULT_BASE_SCORE=100,s._ACTION_OPEN_WORKSPACE="Open Workspace",s._ACTION_DELETE_WORKSPACE="Delete Workspace",s._ACTION_SHARE_WORKSPACE="Share Workspace",s._ACTION_SAVE_WORKSPACE="Save Workspace",s._ACTION_EXISTS_WORKSPACE="Workspace Exists";const n={integrations:new s};export{n as entryPoints};
//# sourceMappingURL=workspaces.bundle.js.map